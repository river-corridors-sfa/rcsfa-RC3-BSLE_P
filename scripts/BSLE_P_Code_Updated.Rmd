---
title: "BSLE_P_Code"
author: "Morgan Barnes"
date: "'2023-08-18'r Sys.Date()'"
output:
  pdf_document: default
  html_document: default
---
##This is the code for figures and statistics from Barnes et al. (2024): phosphorus composition along a burn severity gradient
##Contact: Morgan E Barnes morgan.barnes@pnnl.gov
##Make your environemnt

#### Set Up
```{r setup, include=FALSE, dev="CairoPNG"}
rm(list=ls(all=T))
knitr::opts_chunk$set(echo = TRUE)
```



## Load libraries
```{r library}

require(pacman)

pacman::p_load(tidyverse,
              dplyr,plyr,ggplot2,
              lubridate, tidyr, tidyverse,
              scales, cowplot, gridExtra, RColorBrewer,
              wesanderson,readxl,openxlsx, stringr, hablar,
              janitor, stringr, naniar, forstringr, reshape2, 
              emmeans, rstatix, ggpubr, Hmisc, corrplot, ggrepel, 
              stringr, lme4, lmerTest, car, performance, vegan, psych, lavaan, semPlot)


```

##### Confirm working directory:
```{r working directory check, echo=FALSE}
getwd()
```

##Load data
The datasets and metadata needed for P BSLE Gradient manuscript are:
1) Chemistry datasets solids and liquids w/ all metadata that can be used directly from data package:
This includes: 
a) Total elemental composition of solids
b) Total elemental composition of leachate particulate and filtered fractions
c) Molybdate reactive P of leachate filtered fraction
d) XANES of solids
e) NMR of solids

2) Chemistry data that needs post-data package processing after download from BSLE Data Package v3; this was done and provided within the BSLE P Manuscript Data Package:
a) XANES of solids (spectra of samples and reference compounds and linear combination fits)
b) NMR of solids (deconvolution)


#### Download the BSLE Data Package

Until we can get the API to work, do this manually and store on your local. I recommend storing inside your github folder and gitignoring the subfolder with the data in it by adding this to your .gitignore: 
`#data folder` 
`data/`

BSLE v3 data package URL: https://data.ess-dive.lbl.gov/view/doi:10.15485/1894135
BSLE P manuscript data package URL: INSERT HERE!!! fix

Bring in the data package data:
```{r bsle v3 data package}
#metadata
Meta <- read_csv("../data/BSLE_Data_Package_v3/v1_BSLE_Metadata_and_Protocols/BSLE_Burn_and_Laboratory_Metadata.csv") %>%
  dplyr::rename(Sample_ID = Sample_Name,
                Leachate_vol_mL = Leachate_Volume,
                Char_leached_g = Char_Leached) %>%
  naniar::replace_with_na_all(condition = ~.x ==-9999) %>%
  naniar::replace_with_na_all(condition = ~.x == "N/A") %>%
  mutate(Burn_Severity=replace(Burn_Severity, Burn_Severity=='unburned', 'Unburned'))

Meta<-Meta[ c(2,3,5,8,21,25,26,6,20,22,23)]
Meta$Burn_Severity=factor(Meta$Burn_Severity, levels= c("Unburned", "Low", "Moderate", "High"))

#chemical data from BSLE v3 data package
ICP_Solid <- read_csv("../data/BSLE_Data_Package_v3/v3_BSLE_Data/BSLE_ICP_Solid.csv")
ICP_Leachate <- read_csv("../data/BSLE_Data_Package_v3/v3_BSLE_Data/BSLE_ICP.csv")
MBD <- read_csv("../data/BSLE_Data_Package_v3/v3_BSLE_Data/BSLE_MBD.csv")
ICP_PNMR <- read_csv("../data/BSLE_Data_Package_v3/v3_BSLE_Data/BSLE_ICP_PNMR.csv")
npoctdn <- read_csv("../data/BSLE_Data_Package_v3/v3_BSLE_Data/v2_BSLE_NPOC_TN.csv")
SolidCN <- read_csv("../data/BSLE_Data_Package_v3/v3_BSLE_Data/BSLE_CN.csv")
pH <- read_csv("../data/BSLE_Data_Package_v3/v3_BSLE_Data/BSLE_pH.csv")
NMR_spectra <- read_csv("../data/BSLE_Data_Package_v3/v3_BSLE_Data/BSLE_31P-NMR.csv")


#chemical data from BSLE P manuscript data package
NMR <- read.csv("../data/Barnes_2023_BSLE_P_Gradient_Manuscript_Data_Package/NMR_Deconvolutions.csv") %>%
  filter(Degradation_Corrected == 'Yes')
XANES <- read.csv("../data/Barnes_2023_BSLE_P_Gradient_Manuscript_Data_Package/P_XANES_Samples/P-XANES_LCF.csv")  
XANES_spectra <- read_csv("../data/Barnes_2023_BSLE_P_Gradient_Manuscript_Data_Package/P_XANES_Samples/xanes_example_spectra.csv") #this file was generated using XANES_Spectra_Merging script 

```

Clean up data functions:
```{r functions for cleaning}
essdive_template_cleaning <- function(dataframe){
  cleaned <- dataframe %>% 
  janitor::row_to_names(row_number = which(dataframe[,1] == "Field_Name")) %>% #this assumes that this name is somewhere in column #1. That follows some (most?) ESS-DIVE templates.
 slice(which(Field_Name == "#Start_Data"):which(Field_Name == "#End_Data")) %>%
 select(!Field_Name)
  }

noreporting_format_cleaning <- function(dataframe){
  cleaned <- dataframe %>% 
  janitor::row_to_names(row_number = which(dataframe[,1] == "Date")) #this assumes that this name is somewhere in column #1. This works for the thermocouple datasets
  }
```

```{r bsle v3 data package cleaning}
pH_clean <- essdive_template_cleaning(pH)  %>%
  dplyr::rename(Sample_ID = Sample_Name,
                pH = '00403_pH') %>%
   mutate_at(c(3), as.numeric) %>%
  separate(col=Sample_ID, into = c("Sample_ID", "FilterSize"), sep="-")  %>%
  filter(grepl('unfilt', FilterSize)) %>%
  select(Sample_ID, pH)

#wrote modifies so -9999 is NA, below LOD is NA, and if above or below standard curve then I pull out those values
npoctdn_clean <- essdive_template_cleaning(npoctdn) %>%
  dplyr::rename(NPOC_mg_C_per_L = `00681_NPOC_mg_per_L_as_C`,
         TN_mg_N_per_L = `00602_TN_mg_per_L_as_N`,
         Sample_ID = Sample_Name) %>%
  select(Sample_ID, NPOC_mg_C_per_L, TN_mg_N_per_L) %>%
  filter(grepl('filt0.7', Sample_ID)) %>%
  mutate(Sample_ID = stringr::str_remove(Sample_ID ,"-filt0.2"),
         NPOC_mg_C_per_L = case_when(NPOC_mg_C_per_L == -9999 ~ NA,
                              str_detect(NPOC_mg_C_per_L, "LOD") ~ NA,
                              str_detect(NPOC_mg_C_per_L, "Below_0.1_ppm") ~
                                      str_extract_part(NPOC_mg_C_per_L, "_ppm_Below_0.1_ppm", before = TRUE),
                               TRUE ~ NPOC_mg_C_per_L),
         TN_mg_N_per_L = case_when(TN_mg_N_per_L == -9999 ~ NA,
                              str_detect(TN_mg_N_per_L, "LOD") ~ NA,
                              str_detect(TN_mg_N_per_L, "Below_0.1_ppm") ~ 
                                        str_extract_part(TN_mg_N_per_L, "_ppm_Below_0.1_ppm", before = TRUE),
                               TRUE ~ TN_mg_N_per_L)) %>%
  mutate(NPOC_mg_C_per_L = case_when(str_detect(NPOC_mg_C_per_L, "NPOC_") ~ 
                                     str_extract(NPOC_mg_C_per_L, "(\\d+\\.\\d+)"),
                                     NPOC_mg_C_per_L < 0 ~ NA,
                                     TRUE ~ NPOC_mg_C_per_L),
         TN_mg_N_per_L = case_when(str_detect(TN_mg_N_per_L, "TN_") ~ 
                                     str_extract(TN_mg_N_per_L, "(\\d+\\.\\d+)"),
                                     TN_mg_N_per_L < 0 ~ NA, 
                                     TRUE ~ TN_mg_N_per_L)) %>%
  mutate(NPOC_mg_C_per_L = as.numeric(NPOC_mg_C_per_L),
         TN_mg_N_per_L = as.numeric(TN_mg_N_per_L)) %>%
  separate(col=Sample_ID, into = c("Sample_ID", "FilterSize"), sep="-") 

SolidCN_clean <- essdive_template_cleaning(SolidCN) %>%
  dplyr::rename(C_weight_per = `01463_C_percent`,
         N_weight_per = `01472_N_percent`,
         Parent_ID = Sample_Name) %>%
  select(Parent_ID, C_weight_per,  N_weight_per) %>%
  filter(grepl('solid', Parent_ID)) %>%
  mutate(Parent_ID = stringr::str_remove(Parent_ID ,"-solid"),
         C_weight_per = case_when(C_weight_per == -9999 ~ NA,
                                  str_detect(C_weight_per, "LOD") ~ NA,
                                     TRUE ~ C_weight_per),
         N_weight_per = case_when(N_weight_per == -9999 ~ NA,
                                   str_detect(N_weight_per, "LOD") ~ NA,
                                   TRUE ~ N_weight_per)) %>%
   mutate(C_weight_per = as.numeric(C_weight_per),
         N_weight_per = as.numeric(N_weight_per))

#negative values were replaced with NA, below LOD were replaced with NA, and above/below standard curve were replaced with the value
ICP_Solid_clean<- essdive_template_cleaning(ICP_Solid) %>%
  dplyr::rename(Solid_Ca_mg_kg = '52718_Total_Ca_mg_per_kg',
                Solid_Mg_mg_kg = '52719_Total_Mg_mg_per_kg',
                Solid_P_mg_kg = 'Total_P_mg_per_kg',
                Solid_K_mg_kg = '52720_Total_K_mg_per_kg',
                Solid_Na_mg_kg = '52721_Total_Na_mg_per_kg',
                Solid_S_mg_kg = '01466_Total_S_mg_per_kg',
                Solid_Al_mg_kg = '01462_Total_Al_mg_per_kg',
                Solid_Fe_mg_kg = '01464_Total_Fe_mg_per_kg',
                Parent_ID = 'Sample_Name') %>%
  mutate(Solid_Na_mg_kg = case_when(
                Solid_Na_mg_kg == -9999 ~ NA,
                str_detect(Solid_Na_mg_kg, "Negative_Value") ~ NA, 
                str_detect(Solid_Na_mg_kg, "Below_213.43_LOD") ~ NA, 
                str_detect(Solid_Na_mg_kg, "TotNa_Below") ~ 
                str_extract(Solid_Na_mg_kg, "\\d+\\.?\\d*(?=_ppm_Final_Corrected)"),
                str_detect(Solid_Na_mg_kg, "TotNa_Above") ~ 
                str_extract(Solid_Na_mg_kg, "\\d+\\.?\\d*(?=_ppm_Final_Corrected)"),
                TRUE ~ Solid_Na_mg_kg)) %>%
   mutate_at(c(4:11), as.numeric) %>%
  separate(col=Parent_ID, into = c("Parent_ID", "FilterSize"), sep="-")  %>%
  filter(grepl('solid', FilterSize)) %>%
  select(Parent_ID, Solid_Ca_mg_kg,  Solid_Mg_mg_kg, Solid_P_mg_kg, Solid_K_mg_kg, Solid_Na_mg_kg, Solid_S_mg_kg, Solid_Al_mg_kg, Solid_Fe_mg_kg)


#negative values were replaced with NA, below LOD were replaced with NA, and above/below standard curve were replaced with the value
ICP_Leachate_clean <- essdive_template_cleaning(ICP_Leachate) %>%
  dplyr::rename(Leachate_Ca_mg_L = 'Total_Ca_mg_per_L',
                Leachate_Mg_mg_L = 'Total_Mg_mg_per_L',
                Leachate_P_mg_L = 'Total_P_mg_per_L',
                Leachate_K_mg_L = 'Total_K_mg_per_L',
                Leachate_Na_mg_L = 'Total_Na_mg_per_L',
                Leachate_S_mg_L = 'Total_S_mg_per_L',
                Leachate_Al_mg_L = 'Total_Al_mg_per_L',
                Leachate_Fe_mg_L = 'Total_Fe_mg_per_L',
                Sample_ID = 'Sample_Name') %>%
  mutate(Leachate_Na_mg_L = case_when(
                Leachate_Na_mg_L == -9999 ~ NA,
                str_detect(Leachate_Na_mg_L, "Negative") ~ NA, 
                str_detect(Leachate_Na_mg_L, "LOD") ~ NA, 
                str_detect(Leachate_Na_mg_L, "TotNa_Below") ~ 
                str_extract(Leachate_Na_mg_L, "\\d+\\.?\\d*(?=_ppm_Final_Corrected)"),
                str_detect(Leachate_Na_mg_L, "TotNa_Above") ~ 
                str_extract(Leachate_Na_mg_L, "\\d+\\.?\\d*(?=_ppm_Final_Corrected)"),
                TRUE ~ Leachate_Na_mg_L)) %>%
  mutate(Leachate_Al_mg_L = case_when(
                Leachate_Na_mg_L == -9999 ~ NA,
                str_detect(Leachate_Al_mg_L, "Negative") ~ NA, 
                str_detect(Leachate_Al_mg_L, "LOD") ~ NA, 
                str_detect(Leachate_Al_mg_L, "TotAl_Below") ~ 
                str_extract(Leachate_Al_mg_L, "\\d+\\.?\\d*(?=_ppm_Final_Corrected)"),
                str_detect(Leachate_Al_mg_L, "TotAl_Above") ~ 
                str_extract(Leachate_Al_mg_L, "\\d+\\.?\\d*(?=_ppm_Final_Corrected)"),
                TRUE ~ Leachate_Al_mg_L)) %>%
  mutate(Leachate_Fe_mg_L = case_when(
                Leachate_Fe_mg_L == -9999 ~ NA,
                str_detect(Leachate_Fe_mg_L, "Negative") ~ NA, 
                str_detect(Leachate_Fe_mg_L, "LOD") ~ NA, 
                str_detect(Leachate_Fe_mg_L, "TotAl_Below") ~ 
                str_extract(Leachate_Fe_mg_L, "\\d+\\.?\\d*(?=_ppm_Final_Corrected)"),
                str_detect(Leachate_Fe_mg_L, "TotAl_Above") ~ 
                str_extract(Leachate_Fe_mg_L, "\\d+\\.?\\d*(?=_ppm_Final_Corrected)"),
                TRUE ~ Leachate_Fe_mg_L))  %>%
  mutate_at(c(3:10), as.numeric) %>%
  select(Sample_ID, Leachate_Ca_mg_L,  Leachate_Mg_mg_L, Leachate_P_mg_L, Leachate_K_mg_L, Leachate_Na_mg_L, Leachate_S_mg_L, Leachate_Al_mg_L, Leachate_Fe_mg_L) %>%
  filter(grepl('filt', Sample_ID)) %>%
  separate(col=Sample_ID, into = c("Sample_ID", "FilterSize"), sep="-") 

ICP_Leachate_Filt_clean<- ICP_Leachate_clean %>%
                filter(str_detect(FilterSize, "filt0.")) %>%
  dplyr::rename(Leachate_Ca_mg_L_filt0.7 = 'Leachate_Ca_mg_L',
                Leachate_Mg_mg_L_filt0.7 = 'Leachate_Mg_mg_L',
                Leachate_P_mg_L_filt0.7 = 'Leachate_P_mg_L',
                Leachate_K_mg_L_filt0.7 = 'Leachate_K_mg_L',
                Leachate_Na_mg_L_filt0.7 = 'Leachate_Na_mg_L',
                Leachate_S_mg_L_filt0.7 = 'Leachate_S_mg_L',
                Leachate_Al_mg_L_filt0.7 = 'Leachate_Al_mg_L',
                Leachate_Fe_mg_L_filt0.7 = 'Leachate_Fe_mg_L') %>%
  select(Sample_ID, Leachate_Ca_mg_L_filt0.7,  Leachate_Mg_mg_L_filt0.7, Leachate_P_mg_L_filt0.7, Leachate_K_mg_L_filt0.7, Leachate_Na_mg_L_filt0.7, Leachate_S_mg_L_filt0.7, Leachate_Al_mg_L_filt0.7, Leachate_Fe_mg_L_filt0.7)

ICP_Leachate_Unfilt_clean<- ICP_Leachate_clean %>%
                filter(str_detect(FilterSize, "unfilt")) %>%
  dplyr::rename(Leachate_Ca_mg_L_unfilt = 'Leachate_Ca_mg_L',
                Leachate_Mg_mg_L_unfilt = 'Leachate_Mg_mg_L',
                Leachate_P_mg_L_unfilt = 'Leachate_P_mg_L',
                Leachate_K_mg_L_unfilt = 'Leachate_K_mg_L',
                Leachate_Na_mg_L_unfilt = 'Leachate_Na_mg_L',
                Leachate_S_mg_L_unfilt = 'Leachate_S_mg_L',
                Leachate_Al_mg_L_unfilt = 'Leachate_Al_mg_L',
                Leachate_Fe_mg_L_unfilt = 'Leachate_Fe_mg_L') %>%
  select(Sample_ID, Leachate_Ca_mg_L_unfilt,  Leachate_Mg_mg_L_unfilt, Leachate_P_mg_L_unfilt, Leachate_K_mg_L_unfilt, Leachate_Na_mg_L_unfilt, Leachate_S_mg_L_unfilt, Leachate_Al_mg_L_unfilt, Leachate_Fe_mg_L_unfilt)


#negative values were replaced with zero, below LOD were replaced with NA, and above/below standard curve were replaced with the value (value is corrected for dilution and subtracted by unreactive P to correct for color interference)
#only used concentrations above the high standard if within 15% of it
MBD_Leachate_clean <- essdive_template_cleaning(MBD) %>%
  dplyr::rename(Sample_ID = 'Sample_Name',
                MBD_P_mg_per_L_filt0.7 = 'MBD_P_mg_per_L') %>%
  mutate(MBD_P_mg_per_L_filt0.7 = case_when(
                MBD_P_mg_per_L_filt0.7 == -9999 ~ NA,
                str_detect(MBD_P_mg_per_L_filt0.7, "negative") ~ NA, 
                str_detect(MBD_P_mg_per_L_filt0.7, "LOD") ~ NA, 
                str_detect(Sample_ID, "50A") ~ NA, #hihger than 15% of high standard
                str_detect(MBD_P_mg_per_L_filt0.7, "MBD_Below") ~ 
                str_extract(MBD_P_mg_per_L_filt0.7, "\\d+\\.?\\d*(?=_ppm_Final_Corrected)"),
                str_detect(MBD_P_mg_per_L_filt0.7, "MBD_Above") ~ 
                str_extract(MBD_P_mg_per_L_filt0.7, "\\d+\\.?\\d*(?=_ppm_Final_Corrected)"),
                TRUE ~ MBD_P_mg_per_L_filt0.7)) %>%
  mutate_at(c(2), as.numeric) %>%
  filter(grepl('filt', Sample_ID)) %>%
  separate(col=Sample_ID, into = c("Sample_ID", "FilterSize"), sep="-") %>%
  select(Sample_ID, MBD_P_mg_per_L_filt0.7) %>%
  mutate_at(c(2), as.numeric) %>%
  filter(Sample_ID != "BSLE_0073C") #remove 73C because below limit of quantification

ICP_PNMR_clean <- essdive_template_cleaning(ICP_PNMR) %>%
  dplyr::rename(Parent_ID = 'Sample_Name') %>%
  mutate_at(c(2:8), as.numeric) %>%
  filter(grepl('solid', Parent_ID)) %>%
  separate(col=Parent_ID, into = c("Parent_ID", "FilterSize"), sep="-") %>%
  select(Parent_ID, Total_Extractable_Ca_mg_per_kg,  Total_Extractable_Mg_mg_per_kg, Total_Extractable_P_mg_per_kg, Total_Extractable_K_mg_per_kg,  Total_Extractable_S_mg_per_kg, Total_Extractable_Al_mg_per_kg, Total_Extractable_Fe_mg_per_kg) %>%
  mutate_at(c(2:8), as.numeric) 

XANES_clean <- XANES %>%
  select(-where(~all(is.na(.)))) %>%
  mutate(XANES_Po = rowSums(select(., contains("Po")), na.rm = TRUE)) %>%
  mutate(XANES_Pi = rowSums(select(., contains("Pi")), na.rm = TRUE)) %>%
  mutate(XANES_Fe = rowSums(select(., contains("Fe")), na.rm = TRUE)) %>%
  mutate(XANES_Na = rowSums(select(., contains("Pi_Na") | contains("Po_Na")), na.rm = TRUE)) %>%
  mutate(XANES_Ca = rowSums(select(., contains("Ca") | contains("Apatite")), na.rm = TRUE)) %>%
  mutate(XANES_Al = rowSums(select(., contains("Al")), na.rm = TRUE)) %>%
  mutate(XANES_Mg = rowSums(select(., contains("Mg") | contains("NH4_Mg")), na.rm = TRUE)) %>%
  mutate(XANES_K = rowSums(select(., contains("K")), na.rm = TRUE)) %>%
  mutate(XANES_Pi_Fe = rowSums(select(., contains("Pi_Fe")), na.rm = TRUE)) %>%
  mutate(XANES_Pi_Na = rowSums(select(., contains("Pi_Na")), na.rm = TRUE)) %>%
  mutate(XANES_Pi_Ca = rowSums(select(., contains("Pi_Ca") | contains("Apatite")), na.rm = TRUE)) %>%
  mutate(XANES_Pi_Al = rowSums(select(., contains("Pi_Al")), na.rm = TRUE)) %>%
  mutate(XANES_Pi_Mg = rowSums(select(., contains("Pi_Mg") | contains("NH4_Mg")), na.rm = TRUE)) %>%
  mutate(XANES_Pi_K = rowSums(select(., contains("Pi_K")), na.rm = TRUE)) %>%
  mutate(XANES_Po_Fe = rowSums(select(., contains("Po_Fe")), na.rm = TRUE)) %>%
  mutate(XANES_Po_Na = rowSums(select(., contains("Po_Na")), na.rm = TRUE)) %>%
  mutate(XANES_Po_Ca = rowSums(select(., contains("Po_Ca")), na.rm = TRUE)) %>%
  mutate(XANES_Po_Al = rowSums(select(., contains("Po_Al")), na.rm = TRUE)) %>%
  mutate(XANES_Po_Mg = rowSums(select(., contains("Po_Mg")), na.rm = TRUE)) %>%
  mutate(XANES_Po_K = rowSums(select(., contains("Po_K")), na.rm = TRUE)) %>%
  separate(col=Sample_Name, into = c("Parent_ID", "FilterSize"), sep="-") %>%
  filter(str_detect(FilterSize, "solid"))

NMR_clean <- NMR %>%
  separate(col=Sample_Name, into = c("Parent_ID", "FilterSize"), sep="-") 
```


```{r combine and format data}
data <- Meta %>%
  full_join(SolidCN_clean, by = 'Parent_ID') %>%
  full_join(ICP_Solid_clean, by = 'Parent_ID') %>%
  full_join(ICP_PNMR_clean, by = 'Parent_ID') %>%
  full_join(npoctdn_clean, by = 'Sample_ID') %>%
  full_join(ICP_Leachate_Filt_clean, by = 'Sample_ID') %>%
  full_join(ICP_Leachate_Unfilt_clean, by = 'Sample_ID') %>%
  full_join(MBD_Leachate_clean, by = 'Sample_ID') %>%
  full_join(pH_clean, by = 'Sample_ID') %>%
  mutate_at(c(10:48), as.numeric) %>%
  filter(!is.na(Solid_P_mg_kg))

data$Burn_Severity=factor(data$Burn_Severity, levels= c("Unburned", "Low", "Moderate", "High"))

#create a dataframe for only solids figures and stats to prevent having reps count as extra samples; add NMR and XANES data
data_solids <- data %>%
  filter(str_detect(Sample_ID, "A")) %>%
  select(1:28) %>%
  left_join(NMR_clean) %>%
  left_join(XANES_clean)

data_solids$Burn_Severity=factor(data_solids$Burn_Severity, levels= c("Unburned", "Low", "Moderate", "High"))

#keep XANES separate too
XANES_clean<- Meta %>%
  full_join(XANES_clean, by = 'Parent_ID') %>%
  filter(str_detect(Sample_ID, "A")) %>%
  mutate(Burn_Treatment = as.character(Burn_Treatment)) %>%
  filter(Burn_Treatment %in% c("burn table" , "raw")) %>%
  filter(Land_Coverage_Category %in% c("Douglas-fir forest" , "Sagebrush shrubland")) %>%
  filter(!is.na(FilterSize))
```

####Additional Calcs
```{r Calcs}
#NMR extraction efficiency
data_solids<-data_solids %>%
  mutate(NMR_EE_P_perc=Total_Extractable_P_mg_per_kg/Solid_P_mg_kg*100)

#convert C and N of solids from percent to mg/kg
data_solids<-data_solids %>%
  mutate(Solid_C_mg_kg = (C_weight_per*10000),
  Solid_N_mg_kg = (N_weight_per*10000))


#convert to P relative to solid mass and water volume for Molybdate
data<-data %>%
  mutate(MBD_P_mg_kgchar = MBD_P_mg_per_L_filt0.7*Leachate_vol_mL/Char_leached_g*1000/1000) 

#normalize by P concentration in solid char for Molybdate
data<-data %>%
  mutate(MBD_P_percentofsolid = MBD_P_mg_kgchar/Solid_P_mg_kg*100)

#calculate particulate concentrations as the difference between filtered and unfiltered
data<-data %>%
  mutate(Leachate_Ca_mg_L_part = Leachate_Ca_mg_L_unfilt - Leachate_Ca_mg_L_filt0.7) %>%
  mutate(Leachate_Mg_mg_L_part = Leachate_Mg_mg_L_unfilt - Leachate_Mg_mg_L_filt0.7) %>%
  mutate(Leachate_P_mg_L_part = Leachate_P_mg_L_unfilt - Leachate_P_mg_L_filt0.7) %>%
  mutate(Leachate_K_mg_L_part = Leachate_K_mg_L_unfilt - Leachate_K_mg_L_filt0.7) %>%
  mutate(Leachate_Na_mg_L_part = Leachate_Na_mg_L_unfilt - Leachate_Na_mg_L_filt0.7) %>%
  mutate(Leachate_S_mg_L_part = Leachate_S_mg_L_unfilt - Leachate_S_mg_L_filt0.7) %>%
  mutate(Leachate_Al_mg_L_part = Leachate_Al_mg_L_unfilt - Leachate_Al_mg_L_filt0.7) %>%
  mutate(Leachate_Fe_mg_L_part = Leachate_Fe_mg_L_unfilt - Leachate_Fe_mg_L_filt0.7)

#convert to P relative to solid mass and water volume for the soluble and particulate fractions
data<-data %>%
  mutate(Leachate_Ca_mg_kgchar_part = Leachate_Ca_mg_L_part*Leachate_vol_mL/Char_leached_g*1000/1000) %>%
  mutate(Leachate_Mg_mg_kgchar_part  = Leachate_Mg_mg_L_part*Leachate_vol_mL/Char_leached_g*1000/1000) %>%
  mutate(Leachate_P_mg_kgchar_part  = Leachate_P_mg_L_part*Leachate_vol_mL/Char_leached_g*1000/1000) %>%
  mutate(Leachate_K_mg_kgchar_part  = Leachate_K_mg_L_part*Leachate_vol_mL/Char_leached_g*1000/1000) %>%
  mutate(Leachate_Na_mg_kgchar_part  = Leachate_Na_mg_L_part*Leachate_vol_mL/Char_leached_g*1000/1000) %>%
  mutate(Leachate_S_mg_kgchar_part  = Leachate_S_mg_L_part*Leachate_vol_mL/Char_leached_g*1000/1000) %>%
  mutate(Leachate_Al_mg_kgchar_part  = Leachate_Al_mg_L_part*Leachate_vol_mL/Char_leached_g*1000/1000) %>%
  mutate(Leachate_Fe_mg_kgchar_part  = Leachate_Fe_mg_L_part*Leachate_vol_mL/Char_leached_g*1000/1000) %>%
  mutate(Leachate_Ca_mg_kgchar_filt0.7 = Leachate_Ca_mg_L_filt0.7*Leachate_vol_mL/Char_leached_g*1000/1000) %>%
  mutate(Leachate_Mg_mg_kgchar_filt0.7 = Leachate_Mg_mg_L_filt0.7*Leachate_vol_mL/Char_leached_g*1000/1000) %>%
  mutate(Leachate_P_mg_kgchar_filt0.7 = Leachate_P_mg_L_filt0.7*Leachate_vol_mL/Char_leached_g*1000/1000) %>%
  mutate(Leachate_K_mg_kgchar_filt0.7 = Leachate_K_mg_L_filt0.7*Leachate_vol_mL/Char_leached_g*1000/1000) %>%
  mutate(Leachate_Na_mg_kgchar_filt0.7 = Leachate_Na_mg_L_filt0.7*Leachate_vol_mL/Char_leached_g*1000/1000) %>%
  mutate(Leachate_S_mg_kgchar_filt0.7 = Leachate_S_mg_L_filt0.7*Leachate_vol_mL/Char_leached_g*1000/1000) %>%
  mutate(Leachate_Al_mg_kgchar_filt0.7 = Leachate_Al_mg_L_filt0.7*Leachate_vol_mL/Char_leached_g*1000/1000) %>%
  mutate(Leachate_Fe_mg_kgchar_filt0.7 = Leachate_Fe_mg_L_filt0.7*Leachate_vol_mL/Char_leached_g*1000/1000) %>%
  mutate(Leachate_Ca_mg_kgchar_unfilt = Leachate_Ca_mg_L_unfilt*Leachate_vol_mL/Char_leached_g*1000/1000) %>%
  mutate(Leachate_Mg_mg_kgchar_unfilt  = Leachate_Mg_mg_L_unfilt*Leachate_vol_mL/Char_leached_g*1000/1000) %>%
  mutate(Leachate_P_mg_kgchar_unfilt = Leachate_P_mg_L_unfilt*Leachate_vol_mL/Char_leached_g*1000/1000) %>%
  mutate(Leachate_K_mg_kgchar_unfilt  = Leachate_K_mg_L_unfilt*Leachate_vol_mL/Char_leached_g*1000/1000) %>%
  mutate(Leachate_Na_mg_kgchar_unfilt  = Leachate_Na_mg_L_unfilt*Leachate_vol_mL/Char_leached_g*1000/1000) %>%
  mutate(Leachate_S_mg_kgchar_unfilt  = Leachate_S_mg_L_unfilt*Leachate_vol_mL/Char_leached_g*1000/1000) %>%
  mutate(Leachate_Al_mg_kgchar_unfilt  = Leachate_Al_mg_L_unfilt*Leachate_vol_mL/Char_leached_g*1000/1000) %>%
  mutate(Leachate_Fe_mg_kgchar_unfilt = Leachate_Fe_mg_L_unfilt*Leachate_vol_mL/Char_leached_g*1000/1000)

#convert solid elemental concentrations from to g/kg
data_solids<-data_solids %>%
  mutate(Solid_P_g_kg = Solid_P_mg_kg/1000) %>%
  mutate(Solid_Ca_g_kg = Solid_Ca_mg_kg/1000) %>%
  mutate(Solid_Fe_g_kg = Solid_Fe_mg_kg/1000) %>%
  mutate(Solid_Al_g_kg = Solid_Al_mg_kg/1000) %>%
  mutate(Solid_K_g_kg = Solid_K_mg_kg/1000) %>%
  mutate(Solid_Mg_g_kg = Solid_Mg_mg_kg/1000) %>%
  mutate(Solid_Na_g_kg = Solid_Na_mg_kg/1000) %>%
  mutate(Solid_S_g_kg = Solid_S_mg_kg/1000) %>%
  mutate(Solid_C_g_kg = C_weight_per/100*1000) %>%
  mutate(Solid_N_g_kg = N_weight_per/100*1000)

#normalize by P concentration in solid char fix
data<-data %>%
  mutate(Leachate_Ca_perc_solid_part = Leachate_Ca_mg_kgchar_part/Solid_P_mg_kg*100) %>%
  mutate(Leachate_Mg_perc_solid_part = Leachate_Mg_mg_kgchar_part/Solid_P_mg_kg*100) %>%
  mutate(Leachate_P_perc_solid_part = Leachate_P_mg_kgchar_part/Solid_P_mg_kg*100) %>%
  mutate(Leachate_K_perc_solid_part = Leachate_K_mg_kgchar_part/Solid_P_mg_kg*100) %>%
  mutate(Leachate_Na_perc_solid_part = Leachate_Na_mg_kgchar_part/Solid_P_mg_kg*100) %>%
  mutate(Leachate_S_perc_solid_part = Leachate_S_mg_kgchar_part/Solid_P_mg_kg*100) %>%
  mutate(Leachate_Al_perc_solid_part = Leachate_Al_mg_kgchar_part/Solid_P_mg_kg*100) %>%
  mutate(Leachate_Fe_perc_solid_part = Leachate_Fe_mg_kgchar_part/Solid_P_mg_kg*100) %>%
  mutate(Leachate_Ca_perc_solid_filt0.7 = Leachate_Ca_mg_kgchar_filt0.7/Solid_P_mg_kg*100) %>%
  mutate(Leachate_Mg_perc_solid_filt0.7 = Leachate_Mg_mg_kgchar_filt0.7/Solid_P_mg_kg*100) %>%
  mutate(Leachate_P_perc_solid_filt0.7 = Leachate_P_mg_kgchar_filt0.7/Solid_P_mg_kg*100) %>%
  mutate(Leachate_K_perc_solid_filt0.7 = Leachate_K_mg_kgchar_filt0.7/Solid_P_mg_kg*100) %>%
  mutate(Leachate_Na_perc_solid_filt0.7 = Leachate_Na_mg_kgchar_filt0.7/Solid_P_mg_kg*100) %>%
  mutate(Leachate_S_perc_solid_filt0.7 = Leachate_S_mg_kgchar_filt0.7/Solid_P_mg_kg*100) %>%
  mutate(Leachate_Al_perc_solid_filt0.7 = Leachate_Al_mg_kgchar_filt0.7/Solid_P_mg_kg*100) %>%
  mutate(Leachate_Fe_perc_solid_filt0.7 = Leachate_Fe_mg_kgchar_filt0.7/Solid_P_mg_kg*100)

#FIX THIS
#molar stoichiometry of P:element in solid phase fix
test<-data_solids %>%
  mutate(Fe.P.MolarRatio=(Solid_Fe_mg_kg/55.845/1000)/(Solid_P_mg_kg/30.97/1000))%>%
  mutate(K.P.MolarRatio=(Solid_K_mg_kg/39.0983/1000)/(Solid_P_mg_kg/30.97/1000))%>%
  mutate(Na.P.MolarRatio=(Solid_Na_mg_kg/22.989/1000)/(Solid_P_mg_kg/30.97/1000))%>%
  mutate(Al.P.MolarRatio=(Solid_Al_mg_kg/26.982/1000)/(Solid_P_mg_kg/30.97/1000))%>%
  mutate(Mg.P.MolarRatio=(Solid_Mg_mg_kg/24.305/1000)/(Solid_P_mg_kg/30.97/1000))%>%
  mutate(Ca.P.MolarRatio=(Solid_Ca_mg_kg/40.078/1000)/(Solid_P_mg_kg/30.97/1000))%>%
  mutate(S.P.MolarRatio=(Solid_S_mg_kg/32.065/1000)/(Solid_P_mg_kg/30.97/1000))


#save csv of final collated data with manipulations
write.csv(data, "../data/data.csv", row.names = FALSE) #all data
write.csv(data_solids, "../data/data_solids.csv", row.names = FALSE) #solids only
```


##Quick data import
```{r quick import}
#import data so you don't have to run above code

data <- read_csv("../data/data.csv")
data_solids <- read_csv("../data/data_solids.csv")

data$Burn_Severity=factor(data$Burn_Severity, levels= c("Unburned", "Low", "Moderate", "High"))
```

####summary stats
```{r solids and leachate summary}

#solid elemental concentrations, NMR, and XANES summary
summary_solids_conc <- data_solids %>%
  dplyr::group_by(Burn_Severity, Land_Coverage_Category) %>%
  dplyr::summarize(
    P_Mean = mean(Solid_P_g_kg, na.rm = TRUE),
    P_Standard_Deviation = sd(Solid_P_g_kg, na.rm = TRUE),
    Ca_Mean = mean(Solid_Ca_g_kg, na.rm = TRUE),
    Ca_Standard_Deviation = sd(Solid_Ca_g_kg, na.rm = TRUE),
    Fe_Mean = mean(Solid_Fe_g_kg, na.rm = TRUE),
    Fe_Standard_Deviation = sd(Solid_Fe_g_kg, na.rm = TRUE),
    Al_Mean = mean(Solid_Al_g_kg, na.rm = TRUE),
    Al_Standard_Deviation = sd(Solid_Al_g_kg, na.rm = TRUE),
    K_Mean = mean(Solid_K_g_kg, na.rm = TRUE),
    K_Standard_Deviation = sd(Solid_K_g_kg, na.rm = TRUE),
    Mg_Mean = mean(Solid_Mg_g_kg, na.rm = TRUE),
    Mg_Standard_Deviation = sd(Solid_Mg_g_kg, na.rm = TRUE),
    Na_Mean = mean(Solid_Na_g_kg, na.rm = TRUE),
    Na_Standard_Deviation = sd(Solid_Na_g_kg, na.rm = TRUE),
    S_Mean = mean(Solid_S_g_kg, na.rm = TRUE),
    S_Standard_Deviation = sd(Solid_S_g_kg, na.rm = TRUE),
    C_Mean = mean(Solid_C_g_kg, na.rm = TRUE),
    C_Standard_Deviation = sd(Solid_C_g_kg, na.rm = TRUE),
    N_Mean = mean(Solid_N_g_kg, na.rm = TRUE),
    N_Standard_Deviation = sd(Solid_N_g_kg, na.rm = TRUE),
    Ortho_Mean = mean(Ortho, na.rm = TRUE),
    Ortho_Standard_Deviation = sd(Ortho, na.rm = TRUE),
    Mono_Mean = mean(Mono, na.rm = TRUE),
    Mono_Standard_Deviation = sd(Mono, na.rm = TRUE),
    Di_Mean = mean(Di, na.rm = TRUE),
    Di_Standard_Deviation = sd(Di, na.rm = TRUE),
    Pyro_Mean = mean(Pyro, na.rm = TRUE),
    Pyro_Standard_Deviation = sd(Pyro, na.rm = TRUE),
    XANES_Po_Mean = mean(XANES_Po, na.rm = TRUE),
    XANES_Po_Standard_Deviation = sd(XANES_Po, na.rm = TRUE),
    XANES_Pi_Mean = mean(XANES_Pi, na.rm = TRUE),
    XANES_Pi_Standard_Deviation = sd(XANES_Pi, na.rm = TRUE),
    XANES_Fe_Mean = mean(XANES_Fe, na.rm = TRUE),
    XANES_Fe_Standard_Deviation = sd(XANES_Fe, na.rm = TRUE),
    XANES_Na_Mean = mean(XANES_Na, na.rm = TRUE),
    XANES_Na_Standard_Deviation = sd(XANES_Na, na.rm = TRUE),
    XANES_Ca_Mean = mean(XANES_Ca, na.rm = TRUE),
    XANES_Ca_Standard_Deviation = sd(XANES_Ca, na.rm = TRUE),
    XANES_Al_Mean = mean(XANES_Al, na.rm = TRUE),
    XANES_Al_Standard_Deviation = sd(XANES_Al, na.rm = TRUE),
    XANES_Mg_Mean = mean(XANES_Mg, na.rm = TRUE),
    XANES_Mg_Standard_Deviation = sd(XANES_Mg, na.rm = TRUE),
    XANES_K_Mean = mean(XANES_K, na.rm = TRUE),
    XANES_K_Standard_Deviation = sd(XANES_K, na.rm = TRUE),
    XANES_Pi_Fe_Mean = mean(XANES_Pi_Fe, na.rm = TRUE),
    XANES_Pi_Fe_Standard_Deviation = sd(XANES_Pi_Fe, na.rm = TRUE),
    XANES_Pi_Na_Mean = mean(XANES_Pi_Na, na.rm = TRUE),
    XANES_Pi_Na_Standard_Deviation = sd(XANES_Pi_Na, na.rm = TRUE),
    XANES_Pi_Ca_Mean = mean(XANES_Pi_Ca, na.rm = TRUE),
    XANES_Pi_Ca_Standard_Deviation = sd(XANES_Pi_Ca, na.rm = TRUE),
    XANES_Pi_Al_Mean = mean(XANES_Pi_Al, na.rm = TRUE),
    XANES_Pi_Al_Standard_Deviation = sd(XANES_Pi_Al, na.rm = TRUE),
    XANES_Pi_Mg_Mean = mean(XANES_Pi_Mg, na.rm = TRUE),
    XANES_Pi_Mg_Standard_Deviation = sd(XANES_Pi_Mg, na.rm = TRUE),
    XANES_Pi_K_Mean = mean(XANES_Pi_K, na.rm = TRUE),
    XANES_Pi_K_Standard_Deviation = sd(XANES_Pi_K, na.rm = TRUE),
    XANES_Po_Fe_Mean = mean(XANES_Po_Fe, na.rm = TRUE),
    XANES_Po_Fe_Standard_Deviation = sd(XANES_Po_Fe, na.rm = TRUE),
    XANES_Po_Na_Mean = mean(XANES_Po_Na, na.rm = TRUE),
    XANES_Po_Na_Standard_Deviation = sd(XANES_Po_Na, na.rm = TRUE),
    XANES_Po_Ca_Mean = mean(XANES_Po_Ca, na.rm = TRUE),
    XANES_Po_Ca_Standard_Deviation = sd(XANES_Po_Ca, na.rm = TRUE),
    XANES_Po_Al_Mean = mean(XANES_Po_Al, na.rm = TRUE),
    XANES_Po_Al_Standard_Deviation = sd(XANES_Po_Al, na.rm = TRUE),
    XANES_Po_Mg_Mean = mean(XANES_Po_Mg, na.rm = TRUE),
    XANES_Po_Mg_Standard_Deviation = sd(XANES_Po_Mg, na.rm = TRUE),
    XANES_Po_K_Mean = mean(XANES_Po_K, na.rm = TRUE),
    XANES_Po_K_Standard_Deviation = sd(XANES_Po_K, na.rm = TRUE),
    Count = n()
  )

                   
write.csv(summary_solids_conc, "../data/summary_solids_conc.csv") #save this for a table


#NMR extraction efficiency
summary_solids <- data_solids %>%
  dplyr::group_by(Burn_Severity, Land_Coverage_Category) %>%
  dplyr::summarize(
    Mean = mean(NMR_EE_P_perc, na.rm = TRUE),
    Standard_Deviation = sd(NMR_EE_P_perc, na.rm = TRUE),
    Count = n()
  )

write.csv(summary_solids, "../data/summary_solids_nmr.csv") #save this for a table

#leachate concentrations
P.Conc.leach<- data %>%
  dplyr::group_by(Burn_Severity, Land_Coverage_Category) %>%
  dplyr::summarize(
    Leachate_P_mg_kgchar_part_Mean = mean(Leachate_P_mg_kgchar_part, na.rm = TRUE),
    Leachate_P_mg_kgchar_part_Standard_Deviation = sd(Leachate_P_mg_kgchar_part, na.rm = TRUE),
    Count = n(),
    Leachate_P_mg_kgchar_filt0.7_Mean = mean(Leachate_P_mg_kgchar_filt0.7, na.rm = TRUE),
    Leachate_P_mg_kgchar_filt0.7_Standard_Deviation = sd(Leachate_P_mg_kgchar_filt0.7, na.rm = TRUE),
    Leachate_P_mg_kgchar_unfilt_Mean = mean(Leachate_P_mg_kgchar_unfilt, na.rm = TRUE),
    Leachate_P_mg_kgchar_unfilt_Standard_Deviation = sd(Leachate_P_mg_kgchar_unfilt, na.rm = TRUE)
  )

write.csv(P.Conc.leach, "../data/summary_leachate_conc.csv") #save this for a table
  
```

####Molybdate
```{r MBD fig and stats}
#MBD mg/L figure
ggplot(data, aes(x=Burn_Severity, y=MBD_P_mg_per_L_filt0.7, fill=Land_Coverage_Category))+geom_boxplot(show.legend=FALSE)+theme_classic()+ylab(expression(paste(Soluble~Reactive~P~(mg~P~L^-1), sep="")))+ xlab("Burn Severity")+scale_fill_manual(values=c("#346648", "#dbb40d"))+facet_grid(.~Land_Coverage_Category)+theme(text = element_text(size = 15))

#MBD mg/kg figure; likely use this one for publication
MBD.BS.fig<-ggplot(data, aes(x=Burn_Severity, y=MBD_P_mg_kgchar/1000, fill=Land_Coverage_Category))+geom_boxplot(show.legend=FALSE)+theme_classic()+ylab(expression(paste(Soluble~Reactive~P~(g~P~kg^-1), sep="")))+ xlab("Burn Severity")+scale_fill_manual(values=c("#346648", "#dbb40d"))+facet_grid(.~Land_Coverage_Category)+theme(text = element_text(size = 15))

cowplot::save_plot("../figures/MBD.BS.fig.pdf", MBD.BS.fig, ncol = 1, nrow = 1, base_aspect_ratio= 2:1, dpi=72)

#MBD as percent of solid P concentration figure
ggplot(data, aes(x=Burn_Severity, y=MBD_P_percentofsolid, fill=Land_Coverage_Category))+geom_boxplot(show.legend=FALSE)+theme_classic()+ylab("Soluble Reactive P (%)")+ xlab("Burn Severity")+scale_fill_manual(values=c("#346648", "#dbb40d"))+facet_grid(.~Land_Coverage_Category)+theme(text = element_text(size = 15))

#MBD g/kg stats; likely use this one for publication
model<-lmer(log10(MBD_P_mg_kgchar/1000)~Burn_Severity*Land_Coverage_Category+(1|Parent_ID), data=data) #if want to use maximum likelihood , REML=FALSE
model.BS<-lmer(log10(MBD_P_mg_kgchar/1000)~Land_Coverage_Category+(1|Parent_ID), data=data)
model.LC<-lmer(log10(MBD_P_mg_kgchar/1000)~Burn_Severity+(1|Parent_ID), data=data)
model.int<-lmer(log10(MBD_P_mg_kgchar/1000)~Burn_Severity+Land_Coverage_Category+(1|Parent_ID), data=data)
anova(model,model.BS) #not sig
anova(model,model.LC) #sig
anova(model,model.int) #sig
#check VIF
vif(model)
#model assumptions
hist(log10(data$MBD_P_mg_kgchar))
#linearity
ggqqplot(residuals(model))
#check normality of residuals 
shapiro.test(log10(data$MBD_P_mg_kgchar)) #p > 0.05 so can assume normality 
#check homogeneity of variance assumption (homoscedastcity)
plot(fitted(model),residuals(model))
performance::check_heteroscedasticity(model) #p > 0.05 so can assume homoscedastic
#post hoc tests for interaction term
emmeans::lsmeans(model, pairwise~Burn_Severity*Land_Coverage_Category, at=list(Burn_Severity="Unburned"),adjust="tukey")
emmeans::lsmeans(model, pairwise~Burn_Severity*Land_Coverage_Category, at=list(Burn_Severity="Low"),adjust="tukey")
emmeans::lsmeans(model, pairwise~Burn_Severity*Land_Coverage_Category, at=list(Burn_Severity="Moderate"),adjust="tukey")
emmeans::lsmeans(model, pairwise~Burn_Severity*Land_Coverage_Category, at=list(Land_Coverage_Category="Douglas-fir forest"),adjust="tukey")
emmeans::lsmeans(model, pairwise~Burn_Severity*Land_Coverage_Category, at=list(Land_Coverage_Category="Sagebrush shrubland"),adjust="tukey")

```


####ICP Leachates
```{r leachate ICP fig and stats}
#convert to percent of total P in unfiltered sample
#ICP$P.filt.percentofunfilt<-(ICP$Total_P_mg_per_L_filt/ICP$Total_P_mg_per_L_unfilt)*100
#ICP$P.part.percentofunfilt<-(ICP$Total_P_mg_per_L_part/ICP$Total_P_mg_per_L_unfilt)*100

#total P in unfiltered leachate
Leachate.total.P.BS.boxplot <- ggplot(data, aes(x=Burn_Severity, y=Leachate_P_mg_kgchar_unfilt, fill=Land_Coverage_Category))+geom_boxplot(show.legend=FALSE)+theme_classic()+ylab(expression(paste(Total~P~(mg~P~kg^-1), sep="")))+ xlab("Burn Severity")+scale_fill_manual(values=c("#346648", "#dbb40d"))+facet_grid(.~Land_Coverage_Category)+theme(text = element_text(size = 15))

cowplot::save_plot("../figures/Leachate.total.P.BS.boxplot.pdf", Leachate.total.P.BS.boxplot, ncol = 1, nrow = 1, base_aspect_ratio= 2:1, dpi=72)

Leachate.filt0.7.total.P.BS.boxplot <- ggplot(data, aes(x=Burn_Severity, y=Leachate_P_mg_kgchar_filt0.7, fill=Land_Coverage_Category))+geom_boxplot(show.legend=FALSE)+theme_classic()+ylab(expression(paste(Total~Soluble~P~(mg~P~kg^-1), sep="")))+ xlab("Burn Severity")+scale_fill_manual(values=c("#346648", "#dbb40d"))+facet_grid(.~Land_Coverage_Category)+theme(text = element_text(size = 15))

cowplot::save_plot("../figures/Leachate.filt0.7.total.P.BS.boxplot.pdf", Leachate.filt0.7.total.P.BS.boxplot, ncol = 1, nrow = 1, base_aspect_ratio= 2:1, dpi=72)

Leachate.unfilt.total.P.BS.boxplot <- ggplot(data, aes(x=Burn_Severity, y=Leachate_P_mg_kgchar_part, fill=Land_Coverage_Category))+geom_boxplot(show.legend=FALSE)+theme_classic()+ylab(expression(paste(Total~Particulate~P~(mg~P~kg^-1), sep="")))+ xlab("Burn Severity")+scale_fill_manual(values=c("#346648", "#dbb40d"))+facet_grid(.~Land_Coverage_Category)+theme(text = element_text(size = 15))

cowplot::save_plot("../figures/Leachate.unfilt.total.P.BS.boxplot.pdf", Leachate.unfilt.total.P.BS.boxplot, ncol = 1, nrow = 1, base_aspect_ratio= 2:1, dpi=72)


#stacked bar chart
P.Conc.leach.bar <- P.Conc.leach %>%
  mutate(sd.high=Leachate_P_mg_kgchar_unfilt_Mean+Leachate_P_mg_kgchar_unfilt_Standard_Deviation) %>%
  mutate(sd.low=Leachate_P_mg_kgchar_unfilt_Mean-Leachate_P_mg_kgchar_unfilt_Standard_Deviation)


P.Conc.leach_melt<-melt(P.Conc.leach.bar, id=c("Burn_Severity", "Land_Coverage_Category","sd.low", "sd.high")) %>%
  filter(variable %in% c("Leachate_P_mg_kgchar_part_Mean" , "Leachate_P_mg_kgchar_filt0.7_Mean"))


Leachate_stacked_bar <- ggplot(subset(P.Conc.leach_melt, variable=="Leachate_P_mg_kgchar_part_Mean" | variable=="Leachate_P_mg_kgchar_filt0.7_Mean"), aes(x = Burn_Severity, y = value, fill=variable)) + geom_bar(stat = "identity")  + theme_classic()+ylab(expression(paste(Leachate~Mean~Total~P~(mg~P~kg^-1), sep="")))+ xlab("Burn Severity")+scale_fill_manual(values=c("#2274A5", "#E7DFC6"), labels = c("Particulate", "Soluble"), name = "")+facet_grid(.~Land_Coverage_Category)+theme(text = element_text(size = 15)) + geom_errorbar(aes(ymax=sd.high, ymin=sd.low), width = 0.2, size = 1, color = "black")

cowplot::save_plot("../figures/Leachate_stacked_bar.pdf", Leachate_stacked_bar, ncol = 1, nrow = 1, base_aspect_ratio= 2:1, dpi=72)


#ICP unfiltered total P g/kg stats; likely use this one for publication
model<-lmer(log10(Leachate_P_mg_kgchar_unfilt/1000)~Burn_Severity*Land_Coverage_Category+(1|Parent_ID), data=data)
model.BS<-lmer(log10(Leachate_P_mg_kgchar_unfilt/1000)~Land_Coverage_Category+(1|Parent_ID), data=data)
model.LC<-lmer(log10(Leachate_P_mg_kgchar_unfilt/1000)~Burn_Severity+(1|Parent_ID), data=data)
model.int<-lmer(log10(Leachate_P_mg_kgchar_unfilt/1000)~Burn_Severity+Land_Coverage_Category+(1|Parent_ID), data=data)
anova(model,model.BS)
anova(model,model.LC)
anova(model,model.int)
#check VIF
vif(model)
#model assumptions
hist(log10(data$Leachate_P_mg_kgchar_unfilt/1000))
#linearity
ggqqplot(residuals(model))
#check normality of residuals 
shapiro.test(log10(data$Leachate_P_mg_kgchar_unfilt)) #p > 0.05 so can assume normality 
#check homogeneity of variance assumption (homoscedastcity)
plot(fitted(model),residuals(model))
performance::check_heteroscedasticity(model) #p > 0.05 so can assume homoscedastic
#post hoc tests for interaction term
emmeans::lsmeans(model, pairwise~Burn_Severity*Land_Coverage_Category, at=list(Burn_Severity="Unburned"),adjust="tukey") 
emmeans::lsmeans(model, pairwise~Burn_Severity*Land_Coverage_Category, at=list(Burn_Severity="Low"),adjust="tukey")
emmeans::lsmeans(model, pairwise~Burn_Severity*Land_Coverage_Category, at=list(Burn_Severity="Moderate"),adjust="tukey")
emmeans::lsmeans(model, pairwise~Burn_Severity*Land_Coverage_Category, at=list(Land_Coverage_Category="Douglas-fir forest"),adjust="tukey")
emmeans::lsmeans(model, pairwise~Burn_Severity*Land_Coverage_Category, at=list(Land_Coverage_Category="Sagebrush shrubland"),adjust="tukey")

#ICP filtered (<0.7 nominal phase) total P stats; likely use this one for publication
model<-lmer(log10(Leachate_P_mg_kgchar_filt0.7/1000)~Burn_Severity*Land_Coverage_Category+(1|Parent_ID), data=data)
model.BS<-lmer(log10(Leachate_P_mg_kgchar_filt0.7/1000)~Land_Coverage_Category+(1|Parent_ID), data=data)
model.LC<-lmer(log10(Leachate_P_mg_kgchar_filt0.7/1000)~Burn_Severity+(1|Parent_ID), data=data)
model.int<-lmer(log10(Leachate_P_mg_kgchar_filt0.7/1000)~Burn_Severity+Land_Coverage_Category+(1|Parent_ID), data=data)
anova(model,model.BS) #not sig
anova(model,model.LC) #sig
anova(model,model.int) #not sig but since BS also isn't sig I probably don't care that much about the LC main effect (so not being able to run the post hoc isn't an issue)
#check VIF
vif(model)
#model assumptions
hist(log10(data$Leachate_P_mg_kgchar_filt0.7/1000))
ggqqplot(residuals(model))
#check normality of residuals 
shapiro.test(log10(data$Leachate_P_mg_kgchar_unfilt)) #p > 0.05 so can assume normality 
#check homogeneity of variance assumption (homoscedastcity)
plot(fitted(model),residuals(model))
#no post hoc needed b/c not significant


#ICP particulate (>0.7 nominal phase) total P stats; likely use this one for publication
model<-lmer(log10(Leachate_P_mg_kgchar_part/1000)~Burn_Severity*Land_Coverage_Category+(1|Parent_ID), data=data)
model.BS<-lmer(log10(Leachate_P_mg_kgchar_part/1000)~Land_Coverage_Category+(1|Parent_ID), data=data)
model.LC<-lmer(log10(Leachate_P_mg_kgchar_part/1000)~Burn_Severity+(1|Parent_ID), data=data)
model.int<-lmer(log10(Leachate_P_mg_kgchar_part/1000)~Burn_Severity+Land_Coverage_Category+(1|Parent_ID), data=data)
anova(model,model.BS) #sig
anova(model,model.LC) #sig
anova(model,model.int) #sig
#check VIF
vif(model)
#model assumptions
hist(log10(data$Leachate_P_mg_kgchar_filt0.7/1000))
ggqqplot(residuals(model))
#check normality of residuals 
shapiro.test(log10(data$Leachate_P_mg_kgchar_unfilt)) #p > 0.05 so can assume normality 
#check homogeneity of variance assumption (homoscedastcity)
plot(fitted(model),residuals(model))
performance::check_heteroscedasticity(model) #p > 0.05 so can assume homoscedastic
#interaction post hoc: 
emmeans::lsmeans(model, pairwise~Burn_Severity*Land_Coverage_Category, at=list(Burn_Severity="Unburned"),adjust="tukey") 
emmeans::lsmeans(model, pairwise~Burn_Severity*Land_Coverage_Category, at=list(Burn_Severity="Low"),adjust="tukey") #between 
emmeans::lsmeans(model, pairwise~Burn_Severity*Land_Coverage_Category, at=list(Burn_Severity="Moderate"),adjust="tukey") 
emmeans::lsmeans(model, pairwise~Burn_Severity*Land_Coverage_Category, at=list(Land_Coverage_Category="Douglas-fir forest"),adjust="tukey") 
emmeans::lsmeans(model, pairwise~Burn_Severity*Land_Coverage_Category, at=list(Land_Coverage_Category="Sagebrush shrubland"),adjust="tukey") 
```

####Leachate Figures
```{r four part fig}
#four part figure for leachates: total unfiltered P, total particulate P, total aqueous P, and molybdate reactive P

leach.fig<-data %>%
  select(Burn_Severity, Land_Coverage_Category, Leachate_P_mg_kgchar_unfilt, Leachate_P_mg_kgchar_part, Leachate_P_mg_kgchar_filt0.7, MBD_P_mg_kgchar)

leach.fig<-melt(leach.fig, id =c("Burn_Severity", "Land_Coverage_Category"))

leach.fig<-leach.fig %>%
  mutate(value = value/1000) %>%
  mutate(variable = case_when(
    variable == "Leachate_P_mg_kgchar_unfilt" ~"Total",
    variable == "Leachate_P_mg_kgchar_part" ~"Particulate",
    variable == "Leachate_P_mg_kgchar_filt0.7" ~ "Aqueous",
    variable == "MBD_P_mg_kgchar" ~ "Molybdate Reactive"))
  
leach.fig$variable=factor(leach.fig$variable, levels= c("Total", "Particulate", "Aqueous", "Molybdate Reactive"))

leach.conc<-ggplot(leach.fig, aes(x=Burn_Severity, y=value, fill=Land_Coverage_Category))+geom_boxplot(show.legend=FALSE)+theme_classic()+ylab(expression(paste(P~(mg~g^-1), sep="")))+ xlab("Burn Severity")+scale_fill_manual(values=c("gray", "gray"))+facet_grid(variable~Land_Coverage_Category, scales = "free")+theme(text = element_text(size = 15))

cowplot::save_plot("../figures/leach.conc.pdf", leach.conc, ncol = 1, nrow = 1, base_aspect_ratio= 1.6:2.6, dpi=100)
```


####Solid ICP
```{r solid fig and stats}
solid.P.BS.fig<-ggplot(data_solids, aes(x=Burn_Severity, y=Solid_P_mg_kg, fill=Land_Coverage_Category))+geom_boxplot(show.legend=FALSE)+theme_classic()+ylab(expression(paste(Solid~Total~P~(mg~P~kg^-1), sep="")))+ xlab("Burn Severity")+scale_fill_manual(values=c("#346648", "#dbb40d"))+facet_grid(.~Land_Coverage_Category)+theme(text = element_text(size = 15))

cowplot::save_plot("../figures/solid.P.BS.fig.pdf", solid.P.BS.fig, ncol = 1, nrow = 1, base_aspect_ratio= 2:1, dpi=72)

#ICP solid total P stats; likely use this one for publication
model<-aov(log10(Solid_P_mg_kg)~Burn_Severity*Land_Coverage_Category, data = data_solids)
summary(model)
#model assumptions
hist(log10(data_solids$Solid_P_mg_kg))
ggqqplot(residuals(model))
#check normality of residuals 
shapiro.test(log10(data_solids$Solid_P_mg_kg)) #p > 0.05 so can assume normality 
#check homogeneity of variance assumption (homoscedastcity)
plot(fitted(model),residuals(model))
performance::check_heteroscedasticity(model) #p > 0.05 so can assume homoscedastic
#interaction post hoc: 
emmeans::emmeans(model, pairwise~Burn_Severity*Land_Coverage_Category, at=list(Burn_Severity="Unburned"),adjust="tukey") 
emmeans::emmeans(model, pairwise~Burn_Severity*Land_Coverage_Category, at=list(Burn_Severity="Low"),adjust="tukey") #between 
emmeans::emmeans(model, pairwise~Burn_Severity*Land_Coverage_Category, at=list(Burn_Severity="Moderate"),adjust="tukey") 
emmeans::emmeans(model, pairwise~Burn_Severity*Land_Coverage_Category, at=list(Land_Coverage_Category="Douglas-fir forest"),adjust="tukey") 
emmeans::emmeans(model, pairwise~Burn_Severity*Land_Coverage_Category, at=list(Land_Coverage_Category="Sagebrush shrubland"),adjust="tukey") 
```


####Correlations
```{r elemental correlations}

#across both feedstocks
#subset only solid elemental concentrations (in mg/kg)
data_solids_corr <- data_solids %>%
  select(matches("Solid"))

# Rename columns by extracting everything between "Solid_" and "mg_Kg"
data_solids_corr <- data_solids_corr %>%
  rename_with(
    ~sub("Solid_(.*?)_mg_kg", "\\1", .),
    starts_with("Solid_")) %>%
  select(P, C, N, Ca, Mg, Na, Fe, Al, S, K)

#comput r=the correlation matrix, n=the matrix of the number of observations used in analyzing each pari fo variables, and P=the p-values corresponding to the significance levels of correlations
cor_5 <- rcorr(as.matrix(data_solids_corr), type=c("spearman"))
#define M as the correlation coefficient
M <- cor_5$r
#define p_mat as the p-value
p_mat <- cor_5$P 
#plot only significant pearson correlation coeffcients when p value >0.05
corrplot(M, type = "upper", p.mat = p_mat, sig.level = 0.05, insig = "blank", tl.col = "black", diag=FALSE, na.label="NA", tl.cex=1, cl.cex = 1, number.cex = 0.8, title = "All Ecosystems", mar=c(0,0,1,0), addCoef.col = "white", col = colorRampPalette(c("red", "blue"))(100))


#Douglas-fir forest
#subset only solid elemental concentrations (in mg/kg)
data_solids_corr <- data_solids  %>%
  filter(str_detect(Land_Coverage_Category, "Douglas")) %>%
  select(matches("Solid"))

# Rename columns by extracting everything between "Solid_" and "mg_Kg"
data_solids_corr <- data_solids_corr %>%
  rename_with(
    ~sub("Solid_(.*?)_mg_kg", "\\1", .),
    starts_with("Solid_")) %>%
  select(P, C, N, Ca, Mg, Na, Fe, Al, S, K)

#comput r=the correlation matrix, n=the matrix of the number of observations used in analyzing each pari fo variables, and P=the p-values corresponding to the significance levels of correlations
cor_5 <- rcorr(as.matrix(data_solids_corr), type=c("spearman"))
#define M as the correlation coefficient
M <- cor_5$r
#define p_mat as the p-value
p_mat <- cor_5$P 
#plot only significant pearson correlation coeffcients when p value >0.05
corrplot(M, type = "upper", p.mat = p_mat, sig.level = 0.05, insig = "blank", tl.col = "black", diag=FALSE, na.label="NA", tl.cex=1, cl.cex = 1, number.cex = 0.8, title = "Douglas-fir forest", mar=c(0,0,1,0),addCoef.col = "white", col = colorRampPalette(c("red", "blue"))(100))


#Big sagebrush
#subset only solid elemental concentrations (in mg/kg)
data_solids_corr <- data_solids  %>%
  filter(str_detect(Land_Coverage_Category, "Sagebrush")) %>%
  select(matches("Solid"))

# Rename columns by extracting everything between "Solid_" and "mg_Kg"
data_solids_corr <- data_solids_corr %>%
  rename_with(
    ~sub("Solid_(.*?)_mg_kg", "\\1", .),
    starts_with("Solid_")) %>%
  select(P, C, N, Ca, Mg, Na, Fe, Al, S, K)

#comput r=the correlation matrix, n=the matrix of the number of observations used in analyzing each pari fo variables, and P=the p-values corresponding to the significance levels of correlations
cor_5 <- rcorr(as.matrix(data_solids_corr), type=c("spearman"))
#define M as the correlation coefficient
M <- cor_5$r
#define p_mat as the p-value
p_mat <- cor_5$P 
#plot only significant pearson correlation coeffcients when p value >0.05
corrplot(M, type = "upper", p.mat = p_mat, sig.level = 0.05, insig = "blank", tl.col = "black", diag=FALSE, na.label="NA", tl.cex=1, cl.cex = 1, number.cex = 0.8, title = "Sagebrush shrubland", mar=c(0,0,1,0), addCoef.col = "white", col = colorRampPalette(c("red", "blue"))(100))
```

```{r P w/ CN}
#P and C
ggplot(data_solids, aes(x=Solid_C_mg_kg, y=Solid_P_mg_kg, color = Land_Coverage_Category)) + geom_point() + geom_smooth(method="lm", se = FALSE) + theme_classic() + scale_color_manual(values = c("#346648", "#dbb40d"))

#all feedstocks
model<-lm(log(Solid_C_mg_kg)~log(Solid_P_mg_kg), data = data_solids)
summary(model)
#Douglas fir only
model<-lm(log(Solid_C_mg_kg)~log(Solid_P_mg_kg), data = subset(data_solids, Land_Coverage_Category=="Douglas-fir forest"))
summary(model)
#sagebrush
model<-lm(log(Solid_C_mg_kg)~log(Solid_P_mg_kg), data = subset(data_solids, Land_Coverage_Category=="Sagebrush shrubland"))
summary(model)



#P and N
ggplot(data_solids, aes(x=Solid_N_mg_kg, y=Solid_P_mg_kg, color = Land_Coverage_Category)) + geom_point() + geom_smooth(method="lm", se = FALSE) + theme_classic() + scale_color_manual(values = c("#346648", "#dbb40d"))

#all feedstocks
model<-lm(log(Solid_N_mg_kg)~log(Solid_P_mg_kg), data = data_solids)
summary(model)
#Douglas fir only
model<-lm(log(Solid_N_mg_kg)~log(Solid_P_mg_kg), data = subset(data_solids, Land_Coverage_Category=="Douglas-fir forest"))
summary(model)
#sagebrush
model<-lm(log(Solid_N_mg_kg)~log(Solid_P_mg_kg), data = subset(data_solids, Land_Coverage_Category=="Sagebrush shrubland"))
summary(model)



```


####PCA & RDAs
```{r PCA solid bulk chem}
#PCA of elemental concentration of the solid chars with burn severity and feedstock

#format dataframe using same code as correlation and then also remove NAs
data_solids_corr <- data_solids %>%
  rename_with(
    ~sub("Solid_(.*?)_mg_kg", "\\1", .),
    starts_with("Solid_")) %>%
  select(Burn_Severity, Land_Coverage_Category, P, C, N, Ca, Mg, Na, Fe, Al, S, K) %>%
  na.omit(data_solids)

pca <- prcomp(data_solids_corr[3:12], center=TRUE, scale=TRUE)

##Extract PCA information, including loadings, sample scores, and component percentages
eigval <- pca$sdev^2
eigvec <- data.frame(pca$rotation)
loadings1 <- eigvec$PC1*sqrt(eigval[1])
loadings2 <- eigvec$PC2*sqrt(eigval[2])
loadings <- cbind(loadings1, loadings2)

colnames(loadings)<-c('PC1','PC2')
rownames(loadings)<-colnames(data_solids_corr[3:12])
loadingstest<-as.data.frame(loadings)
pca_out <- as.data.frame(pca$x)
percentage <- round(pca$sdev^2/sum(pca$sdev^2)*100,1)
percentage <- paste(colnames(pca_out), "-", paste(as.character(percentage), "%", sep=""))


xscale <- 10
yscale <- 10
ggplot()+geom_point(data=pca_out,mapping=aes(x=PC1, y=PC2, colour=data_solids_corr$Land_Coverage_Category,shape=data_solids_corr$Burn_Severity),size=3)+xlim(-xscale,xscale)+ylim(-yscale,yscale)+geom_abline(intercept=0, slope=0, linetype="dashed", size=0.8, colour="gray")+geom_vline(aes(xintercept=0), linetype="dashed", size=0.8, colour="gray")+theme_light()+labs(colour="Land_Coverage_Category",shape="Burn_Severity")+theme(panel.grid.major=element_blank(),panel.grid.minor=element_blank(),panel.background=element_blank(),axis.title.x=element_text(size=16),axis.title.y=element_text(size=16),axis.text.y=element_text(size=16),axis.text.x=element_text(size=16),legend.title=element_text(size=12),legend.text=element_text(size=12),legend.position="bottom",legend.box="verticle",legend.margin=margin())+xlab(percentage[1])+ylab(percentage[2])+guides(color=guide_legend(nrow=2, byrow=TRUE))+scale_color_manual(values=c("#346648", "#dbb40d"))+scale_shape_manual(values=c(16,17,3,12))+geom_text_repel(data=loadingstest,mapping=aes(label=row.names(loadingstest), x=PC1*xscale, y=PC2*yscale),size=5, colour="black", alpha=0.5)


```

```{r PCA leachate bulk chem in both fractions}
#include pH, particulate concentrations from ICP, and filt0.7 concentrations from ICP, NPOC, TDN, MBD 

#fix THIS DOESN"T WORK RIGHT NOW
#format dataframe and then also remove NAs
#data_solids_corr <- data_solids %>%
#  rename_with(
#    ~sub("Leachate_(.*?)_mg_kg", "\\1", .),
#    starts_with("Leachate_")) %>%
#  select(Burn_Severity, Land_Coverage_Category, P, C, N, Ca, Mg, Na, Fe, Al, S, K) %>%
#  na.omit(data_solids)

```

```{r PCA XANES}
#PCAs of XANES LCF

#FIX THIS DOENS'T RUN RIGHT NOW

#all phases together; open air; Po individual species

#format dataframe using same code as correlation and then also remove NAs
#XANES_corr <- XANES_clean %>%
#  select(Parent_ID, Burn_Severity, Land_Coverage_Category, FilterSize, XANES_Pi_Al, XANES_Pi_Ca, XANES_Pi_Fe, #XANES_Pi_K, XANES_Pi_Mg, XANES_Pi_Na, XANES_Po_Al, XANES_Po_Fe, XANES_Po_Ca, XANES_Po_Na) %>%
#  na.omit(XANES_clean)

#pca <- prcomp(XANES_corr[5:14], center=TRUE, scale=TRUE)

##Extract PCA information, including loadings, sample scores, and component percentages
#eigval <- pca$sdev^2
#eigvec <- data.frame(pca$rotation)
#loadings1 <- eigvec$PC1*sqrt(eigval[1])
#loadings2 <- eigvec$PC2*sqrt(eigval[2])
#loadings <- cbind(loadings1, loadings2)

#colnames(loadings)<-c('PC1','PC2')
#rownames(loadings)<-colnames(XANES_corr[5:14])
#loadingstest<-as.data.frame(loadings)
#pca_out <- as.data.frame(pca$x)
#percentage <- round(pca$sdev^2/sum(pca$sdev^2)*100,1)
#percentage <- paste(colnames(pca_out), "-", paste(as.character(percentage), "%", sep=""))


#xscale <- 4
#yscale <- 4
#ggplot()+geom_point(data=pca_out,mapping=aes(x=PC1, y=PC2, colour=XANES_corr$Land_Coverage_Category,shape=XANES_corr$Burn_Severity, size=XANES_corr$FilterSize))+xlim(-xscale,xscale)+ylim(-yscale,yscale)+geom_abline(intercept=0, slope=0, linetype="dashed", size=0.8, colour="gray")+geom_vline(aes(xintercept=0), linetype="dashed", size=0.8, colour="gray")+theme_light()+labs(colour="Land_Coverage_Category",shape="Burn_Severity")+theme(panel.grid.major=element_blank(),panel.grid.minor=element_blank(),panel.background=element_blank(),axis.title.x=element_text(size=16),axis.title.y=element_text(size=16),axis.text.y=element_text(size=16),axis.text.x=element_text(size=16),legend.title=element_text(size=12),legend.text=element_text(size=12),legend.position="bottom",legend.box="verticle",legend.margin=margin())+xlab(percentage[1])+ylab(percentage[2])+guides(color=guide_legend(nrow=2, byrow=TRUE))+scale_color_manual(values=c("#346648", "#dbb40d"))+scale_shape_manual(values=c(16,17,3,12))+scale_size_manual(values=c(3,6,9))+geom_text_repel(data=loadingstest,mapping=aes(label=row.names(loadingstest), x=PC1*xscale, y=PC2*yscale),size=5, colour="black", alpha=0.5)+ggtitle("Open Air XANES - all phases")


#all phases together; open air; Po total instead of individual

#format dataframe using same code as correlation and then also remove NAs
#XANES_corr <- XANES_clean %>%
#  select(Parent_ID, Burn_Severity, Land_Coverage_Category, FilterSize, XANES_Pi_Al, XANES_Pi_Ca, XANES_Pi_Fe, XANES_Pi_K, XANES_Pi_Mg, XANES_Pi_Na, XANES_Po) %>%
#  na.omit(XANES_clean)

#pca <- prcomp(XANES_corr[5:11], center=TRUE, scale=TRUE)

##Extract PCA information, including loadings, sample scores, and component percentages
#eigval <- pca$sdev^2
#eigvec <- data.frame(pca$rotation)
#loadings1 <- eigvec$PC1*sqrt(eigval[1])
#loadings2 <- eigvec$PC2*sqrt(eigval[2])
#loadings <- cbind(loadings1, loadings2)

#colnames(loadings)<-c('PC1','PC2')
#rownames(loadings)<-colnames(XANES_corr[5:11])
#loadingstest<-as.data.frame(loadings)
#pca_out <- as.data.frame(pca$x)
#percentage <- round(pca$sdev^2/sum(pca$sdev^2)*100,1)
#percentage <- paste(colnames(pca_out), "-", paste(as.character(percentage), "%", sep=""))


#xscale <- 4
#yscale <- 4
#ggplot()+geom_point(data=pca_out,mapping=aes(x=PC1, y=PC2, colour=XANES_corr$Land_Coverage_Category,shape=XANES_corr$Burn_Severity, size=XANES_corr$FilterSize))+xlim(-xscale,xscale)+ylim(-yscale,yscale)+geom_abline(intercept=0, slope=0, linetype="dashed", size=0.8, colour="gray")+geom_vline(aes(xintercept=0), linetype="dashed", size=0.8, colour="gray")+theme_light()+labs(colour="Land_Coverage_Category",shape="Burn_Severity")+theme(panel.grid.major=element_blank(),panel.grid.minor=element_blank(),panel.background=element_blank(),axis.title.x=element_text(size=16),axis.title.y=element_text(size=16),axis.text.y=element_text(size=16),axis.text.x=element_text(size=16),legend.title=element_text(size=12),legend.text=element_text(size=12),legend.position="bottom",legend.box="verticle",legend.margin=margin())+xlab(percentage[1])+ylab(percentage[2])+guides(color=guide_legend(nrow=2, byrow=TRUE))+scale_color_manual(values=c("#346648", "#dbb40d"))+scale_shape_manual(values=c(16,17,3,12))+scale_size_manual(values=c(3,6,9))+geom_text_repel(data=loadingstest,mapping=aes(label=row.names(loadingstest), x=PC1*xscale, y=PC2*yscale),size=5, colour="black", alpha=0.5)+ggtitle("Open Air XANES - all phases")



#solid only; open air; Po individual species

#format dataframe using same code as correlation and then also remove NAs; also removed columns that were all zeros for this phase
XANES_corr <- XANES_clean %>%
  select(Parent_ID, Burn_Severity, Land_Coverage_Category, FilterSize, XANES_Pi_Al, XANES_Pi_Ca, XANES_Pi_Fe, XANES_Pi_K, XANES_Pi_Mg, XANES_Pi_Na, XANES_Po_Ca, XANES_Po_Na) %>%
  na.omit(XANES_clean) %>%
  filter(FilterSize %in% c("solid"))

pca <- prcomp(XANES_corr[5:12], center=TRUE, scale=TRUE)

##Extract PCA information, including loadings, sample scores, and component percentages
eigval <- pca$sdev^2
eigvec <- data.frame(pca$rotation)
loadings1 <- eigvec$PC1*sqrt(eigval[1])
loadings2 <- eigvec$PC2*sqrt(eigval[2])
loadings <- cbind(loadings1, loadings2)

colnames(loadings)<-c('PC1','PC2')
rownames(loadings)<-colnames(XANES_corr[5:12])
loadingstest<-as.data.frame(loadings)
pca_out <- as.data.frame(pca$x)
percentage <- round(pca$sdev^2/sum(pca$sdev^2)*100,1)
percentage <- paste(colnames(pca_out), "-", paste(as.character(percentage), "%", sep=""))


xscale <- 4
yscale <- 4
ggplot()+geom_point(data=pca_out,mapping=aes(x=PC1, y=PC2, colour=XANES_corr$Land_Coverage_Category,shape=XANES_corr$Burn_Severity),size=5)+xlim(-xscale,xscale)+ylim(-yscale,yscale)+geom_abline(intercept=0, slope=0, linetype="dashed", size=0.8, colour="gray")+geom_vline(aes(xintercept=0), linetype="dashed", size=0.8, colour="gray")+theme_light()+labs(colour="Land_Coverage_Category",shape="Burn_Severity")+theme(panel.grid.major=element_blank(),panel.grid.minor=element_blank(),panel.background=element_blank(),axis.title.x=element_text(size=16),axis.title.y=element_text(size=16),axis.text.y=element_text(size=16),axis.text.x=element_text(size=16),legend.title=element_text(size=12),legend.text=element_text(size=12),legend.position="bottom",legend.box="verticle",legend.margin=margin())+xlab(percentage[1])+ylab(percentage[2])+guides(color=guide_legend(nrow=2, byrow=TRUE))+scale_color_manual(values=c("#346648", "#dbb40d"))+scale_shape_manual(values=c(16,17,3,12))+geom_text_repel(data=loadingstest,mapping=aes(label=row.names(loadingstest), x=PC1*xscale, y=PC2*yscale),size=5, colour="black", alpha=0.5)+ggtitle("Open Air XANES - Solid")



#solid only; open air; Po grouped

#format dataframe using same code as correlation and then also remove NAs; also removed columns that were all zeros for this phase
XANES_corr <- XANES_clean %>%
  select(Parent_ID, Burn_Severity, Land_Coverage_Category, FilterSize, XANES_Pi_Al, XANES_Pi_Ca, XANES_Pi_Fe, XANES_Pi_K, XANES_Pi_Mg, XANES_Pi_Na, XANES_Po) %>%
  na.omit(XANES_clean) %>%
  filter(FilterSize %in% c("solid"))

pca <- prcomp(XANES_corr[5:11], center=TRUE, scale=TRUE)

##Extract PCA information, including loadings, sample scores, and component percentages
eigval <- pca$sdev^2
eigvec <- data.frame(pca$rotation)
loadings1 <- eigvec$PC1*sqrt(eigval[1])
loadings2 <- eigvec$PC2*sqrt(eigval[2])
loadings <- cbind(loadings1, loadings2)

colnames(loadings)<-c('PC1','PC2')
rownames(loadings)<-colnames(XANES_corr[5:11])
loadingstest<-as.data.frame(loadings)
pca_out <- as.data.frame(pca$x)
percentage <- round(pca$sdev^2/sum(pca$sdev^2)*100,1)
percentage <- paste(colnames(pca_out), "-", paste(as.character(percentage), "%", sep=""))


xscale <- 4
yscale <- 4
ggplot()+geom_point(data=pca_out,mapping=aes(x=PC1, y=PC2, colour=XANES_corr$Land_Coverage_Category,shape=XANES_corr$Burn_Severity),size=5)+xlim(-xscale,xscale)+ylim(-yscale,yscale)+geom_abline(intercept=0, slope=0, linetype="dashed", size=0.8, colour="gray")+geom_vline(aes(xintercept=0), linetype="dashed", size=0.8, colour="gray")+theme_light()+labs(colour="Land_Coverage_Category",shape="Burn_Severity")+theme(panel.grid.major=element_blank(),panel.grid.minor=element_blank(),panel.background=element_blank(),axis.title.x=element_text(size=16),axis.title.y=element_text(size=16),axis.text.y=element_text(size=16),axis.text.x=element_text(size=16),legend.title=element_text(size=12),legend.text=element_text(size=12),legend.position="bottom",legend.box="verticle",legend.margin=margin())+xlab(percentage[1])+ylab(percentage[2])+guides(color=guide_legend(nrow=2, byrow=TRUE))+scale_color_manual(values=c("#346648", "#dbb40d"))+scale_shape_manual(values=c(16,17,3,12))+geom_text_repel(data=loadingstest,mapping=aes(label=row.names(loadingstest), x=PC1*xscale, y=PC2*yscale),size=5, colour="black", alpha=0.5)+ggtitle("Open Air XANES - Solid")
```

```{r PCA NMR and XANES}
leachate <- data %>%
  select(1:3, 5, 10, 11, 49, 62, 70, 78, 50)
leachate_mean <- leachate %>%
  dplyr::group_by(Parent_ID) %>%
  dplyr::summarize(
    Leachate_P_mg_kgchar_unfilt_Mean = mean(Leachate_P_mg_kgchar_unfilt, na.rm = TRUE),
    Leachate_P_mg_kgchar_part_Mean = mean(Leachate_P_mg_kgchar_part, na.rm = TRUE),
    Leachate_P_mg_kgchar_filt0.7_Mean = mean(Leachate_P_mg_kgchar_filt0.7, na.rm = TRUE),
    MBD_P_mg_kgchar_Mean = mean(MBD_P_mg_kgchar, na.rm = TRUE),
    pH_Mean = mean(pH)
  )

solid <- data_solids %>%
  select(1,3, 5, 10, 11, 31:34, 88, 96:101, 111:120)

data_rda<- solid %>%
  full_join(leachate_mean) #%>%
  #na.omit(solid) #remove NAs

data_rda <- data_rda %>%
  select(2,3,6:17, 27:30)

pca <- prcomp(data_rda[3:18], center=TRUE, scale=TRUE)

##Extract PCA information, including loadings, sample scores, and component percentages
eigval <- pca$sdev^2
eigvec <- data.frame(pca$rotation)
loadings1 <- eigvec$PC1*sqrt(eigval[1])
loadings2 <- eigvec$PC2*sqrt(eigval[2])
loadings <- cbind(loadings1, loadings2)

colnames(loadings)<-c('PC1','PC2')
rownames(loadings)<-colnames(data_rda[3:18])
loadingstest<-as.data.frame(loadings)
pca_out <- as.data.frame(pca$x)
percentage <- round(pca$sdev^2/sum(pca$sdev^2)*100,1)
percentage <- paste(colnames(pca_out), "-", paste(as.character(percentage), "%", sep=""))


xscale <- 6
yscale <- 6
ggplot()+geom_point(data=pca_out,mapping=aes(x=PC1, y=PC2, colour=data_rda$Land_Coverage_Category,shape=data_rda$Burn_Severity),size=5)+xlim(-xscale,xscale)+ylim(-yscale,yscale)+geom_abline(intercept=0, slope=0, linetype="dashed", size=0.8, colour="gray")+geom_vline(aes(xintercept=0), linetype="dashed", size=0.8, colour="gray")+theme_light()+labs(colour="Land_Coverage_Category",shape="Burn_Severity")+theme(panel.grid.major=element_blank(),panel.grid.minor=element_blank(),panel.background=element_blank(),axis.title.x=element_text(size=16),axis.title.y=element_text(size=16),axis.text.y=element_text(size=16),axis.text.x=element_text(size=16),legend.title=element_text(size=12),legend.text=element_text(size=12),legend.position="bottom",legend.box="verticle",legend.margin=margin())+xlab(percentage[1])+ylab(percentage[2])+guides(color=guide_legend(nrow=2, byrow=TRUE))+scale_color_manual(values=c("#346648", "#dbb40d"))+scale_shape_manual(values=c(16,17,3,12))+geom_text_repel(data=loadingstest,mapping=aes(label=row.names(loadingstest), x=PC1*xscale, y=PC2*yscale),size=5, colour="black", alpha=0.5)

```

```{r RDAs}
#setting up an RDA to look at how burn conditions (severity, duration, max temp) and chemistry of solid char (P, Ca, Mg, K, Fe, Al, Na concentration, XANES categories, and NMR categories) impact P mobilization (total P concentration in unfiltered leachate, aqueous phase (<0.7), and particulate phase (>0.7); soluble reactive P)


#this is example code of how to do an RDA
#reference: http://dmcglinn.github.io/quant_methods/lessons/multivariate_models.html
#other reference: https://popgen.nescent.org/2018-03-27_RDA_GEA.html
#citation in here: https://cran.r-project.org/web/packages/vegan/vignettes/FAQ-vegan.html
#reference about scaling: https://mb3is.megx.net/gustame/constrained-analyses/rda

#make dataframe with all leachate samples
leachate <- data %>%
  select(1:3, 5, 10, 11, 49, 62, 70, 78, 50)

solid <- data_solids %>%
  select(1, 31:34, 88, 96:101, 111:120)

data_rda<- leachate %>%
  full_join(solid) %>%
  filter(Solid_Na_g_kg != "") #remove NAs

#create dataframe for sample variables
samples<-data_rda[ c(7:32)]
#create dataframe for burn condition variables
enviro<-data_rda[ c(4:6)]

#make dataframe with solid samples (leachate avg) to prevent using same number so many times
#alternative RDA: avergae leachate concentrations
leachate_mean <- leachate %>%
  dplyr::group_by(Parent_ID) %>%
  dplyr::summarize(
    Leachate_P_mg_kgchar_unfilt_Mean = mean(Leachate_P_mg_kgchar_unfilt, na.rm = TRUE),
    Leachate_P_mg_kgchar_part_Mean = mean(Leachate_P_mg_kgchar_part, na.rm = TRUE),
    Leachate_P_mg_kgchar_filt0.7_Mean = mean(Leachate_P_mg_kgchar_filt0.7, na.rm = TRUE),
    MBD_P_mg_kgchar_Mean = mean(MBD_P_mg_kgchar, na.rm = TRUE),
    pH_Mean = mean(pH)
  )

solid <- data_solids %>%
  select(1,3, 5, 10, 11, 31:34, 88, 96:101, 111:120)

data_rda<- solid %>%
  full_join(leachate_mean) %>%
  filter(Solid_Na_g_kg != "") #remove NAs

#RDA: How do burn conditions (severity, duration, temp) influence chemistry of solids and leachates?
#create dataframe for sample variables
samples<-data_rda[ c(6:31)]
#create dataframe for burn condition variables
enviro<-data_rda[ c(3:5)]

#make sure both dataframes have equal rows
all.equal(rownames(samples), rownames(enviro))

#RDA (this anaysis expects a linear response of each sample to the environmental variables)
rda_tree=rda(samples~ . , data=enviro)
rda_tree
RsquareAdj(rda_tree)
summary(eigenvals(rda_tree, model = "constrained"))

#see the factor loadings (correlations of each variable with each pca axis)
scores(rda_tree, choices=1:2, display="species", scaling=2)

#plot it
plot(rda_tree, type='n', scaling=2)
orditorp(rda_tree, display='sp', cex=0.5, scaling=1, col='blue')
text(rda_tree, display='cn', col='red')

#check correlation
pairs.panels(enviro, scale=T)

#can visualize RDA importance
screeplot(rda_tree)

#check significance of all PCAs
signif.full <- anova.cca(rda_tree, parallel=getOption("mc.cores")) # default is permutation=999
signif.full #model is significant

#check significance of individual PCAs
signif.axis <- anova.cca(rda_tree, by="axis", parallel=getOption("mc.cores"))
signif.axis 

#check VIF
vif.cca(rda_tree)

#compare the model to chance with permutation test
anova(rda_tree)

#plot again
plot(rda_tree, scaling=2) #this just doesn't work; not significant, VIF too high



#RDA: How does solid P chemistry (NMR, XANES) influence elemental concentrations in leachate (unfilt, filt, part, molybdate)?; color by burn severity, shape by feedstock; uses leachate means; VIF is too high
data_rda<- solid %>%
  full_join(leachate_mean) %>%
  filter(Solid_Na_g_kg != "") #remove NAs

#create dataframe for sample variables
samples<-data_rda[ c(27:30)]
#create dataframe for burn condition variables
enviro<-data_rda[ c(6:16)]

#make sure both dataframes have equal rows
all.equal(rownames(samples), rownames(enviro))

#RDA (this anaysis expects a linear response of each sample to the environmental variables)
rda_tree=rda(samples~ . , data=enviro)
rda_tree
RsquareAdj(rda_tree)
summary(eigenvals(rda_tree, model = "constrained"))

#see the factor loadings (correlations of each variable with each pca axis)
scores(rda_tree, choices=1:2, display="species", scaling=2)

#plot it
plot(rda_tree, type='n', scaling=2)
orditorp(rda_tree, display='sp', cex=0.5, scaling=1, col='blue')
text(rda_tree, display='cn', col='red')

#check correlation
pairs.panels(enviro, scale=T)

#can visualize RDA importance
screeplot(rda_tree)

#check significance of all PCAs
signif.full <- anova.cca(rda_tree, parallel=getOption("mc.cores")) # default is permutation=999
signif.full #model is significant

#check significance of individual PCAs
signif.axis <- anova.cca(rda_tree, by="axis", parallel=getOption("mc.cores"))
signif.axis #only RDA1 and RDA 2 are sig

#check VIF
vif.cca(rda_tree)

#compare the model to chance with permutation test
anova(rda_tree)

#plot again
plot(rda_tree, scaling=2) #this just doesn't work; not significant, VIF too high




#How does feedstock and burn severity influence solid P chemistry (P conc, NMR, XANES)?
data_rda<- solid %>%
  full_join(leachate_mean) 

#create dataframe for sample variables
samples<-data_rda[ c(6:17)]
#create dataframe for burn condition variables
enviro<-data_rda[ c(2:3)]

#make sure both dataframes have equal rows
all.equal(rownames(samples), rownames(enviro))

#RDA (this anaysis expects a linear response of each sample to the environmental variables)
rda_tree=rda(samples~ . , data=enviro)
rda_tree
RsquareAdj(rda_tree)
summary(eigenvals(rda_tree, model = "constrained"))

#see the factor loadings (correlations of each variable with each pca axis)
scores(rda_tree, choices=1:2, display="species", scaling=2)

#plot it
plot(rda_tree, type='n', scaling=2)
orditorp(rda_tree, display='sp', cex=0.5, scaling=1, col='blue')
text(rda_tree, display='cn', col='red')

#check correlation
pairs.panels(enviro, scale=T)

#can visualize RDA importance
screeplot(rda_tree)

#check significance of all PCAs
signif.full <- anova.cca(rda_tree, parallel=getOption("mc.cores")) # default is permutation=999
signif.full #model is significant

#check significance of individual PCAs
signif.axis <- anova.cca(rda_tree, by="axis", parallel=getOption("mc.cores"))
signif.axis #only RDA1 and RDA 2 are sig

#check VIF
vif.cca(rda_tree)

#compare the model to chance with permutation test
anova(rda_tree)

#plot again
plot(rda_tree, scaling=2) #this is significant and VIF is good; make this one pretty



#How does feedstock and burn severity influence solid (P concentration, NMR, XANES) and leachate (concentration of different phases and molybdate) chemistry 
data_rda<- solid %>%
  full_join(leachate_mean) 

#create dataframe for sample variables
samples<-data_rda[ c(6:17, 27:30)]
#create dataframe for burn condition variables
enviro<-data_rda[ c(2:3)]

#make sure both dataframes have equal rows
all.equal(rownames(samples), rownames(enviro))

#RDA (this anaysis expects a linear response of each sample to the environmental variables)
rda_tree=rda(samples~ . , data=enviro)
rda_tree
RsquareAdj(rda_tree)
summary(eigenvals(rda_tree, model = "constrained"))

#see the factor loadings (correlations of each variable with each pca axis)
scores(rda_tree, choices=1:2, display="species", scaling=2)

#plot it
plot(rda_tree, type='n', scaling=2)
orditorp(rda_tree, display='sp', cex=0.5, scaling=1, col='blue')
text(rda_tree, display='cn', col='red')

#check correlation
pairs.panels(enviro, scale=T)

#can visualize RDA importance
screeplot(rda_tree)

#check significance of all PCAs
signif.full <- anova.cca(rda_tree, parallel=getOption("mc.cores")) # default is permutation=999
signif.full #model is significant

#check significance of individual PCAs
signif.axis <- anova.cca(rda_tree, by="axis", parallel=getOption("mc.cores"))
signif.axis #only RDA1 and RDA 2 are sig

#check VIF
vif.cca(rda_tree)

#compare the model to chance with permutation test
anova(rda_tree)

#plot again
plot(rda_tree, scaling=2) #this is isn't as good with the leachates included



#make a pretty plot
#use
#USE THIS ONE AS AN EXAMPLE!! (has horizons as difference shapes but need to figure out legend)
#levels(enviro$Site) <- c("GR2","GR3","GR5","BAR","SJER","SPR", "PR", "SH")
#eco <- enviro$Site
#bgg <- c("#000080", "#8B0000","#0E5E0B","#606060","#5B94BA","#DF1111", "#069710",  "#C9D4D1") # 8 colors for our sites
#shapes <- c(18, 16, 15,17) 
#sh <- as.factor(enviro$Horizon)
#plot(rda_tree, type="n", scaling=2)
#points(rda_tree, display="species", pch=20, cex=0.7, col="gray32", scaling=2)           #the chemical species from NMR and XANES
#points(rda_tree, display="sites", pch=shapes[sh], cex=1.3, scaling=2, col=bgg[eco]) # the soil samples
#text(rda_tree, scaling=2, display="bp", col="#0868ac", cex=1)                           # the predictors
#legend("bottomright", legend=levels(eco), bty="n", pch=21, cex=1, col=bg)
#legend("bottomright", legend=c("A", "B", "C", "GR2", "GR3", "GR5", "BAR", "SJER", "SPR", "PR", "SH"), col=c(rep("black",3), "#000080", "#8B0000","#0E5E0B","#606060","#5B94BA","#DF1111", "#069710",  "#C9D4D1"), pch=c(16, 15, 17, 16, 16, 16, 16, 16, 16, 16, 16))


#surface horizons only
#Master_CZO_WM_Soil_5.8.2020 <- read.csv("~/Documents/Research Notes/Dissertation General/Master_CZO_WM_Soil_5.8.2020.csv")
#Master_CZO_WM_Soil_5.8.2020$Climo<-factor(Master_CZO_WM_Soil_5.8.2020$Climo, levels=c("WM", "CZO"))
#xas.percent<-subset(Master_CZO_WM_Soil_5.8.2020, Sample.Type=="Soil")
#xas.percent<-xas.percent[ , c("Horizon.Category.C",  "Climo", "Site", "EEMT", "AI", "MAT", "MAP","pH.CaCl2", "Clay.Percent", "Fe.g.kgsoil.PMnorm", "Ca.g.kgsoil.PMnorm", "Al.g.kgsoil.PMnorm", "C.g.kgsoil", "P.g.kgsoil.PMnorm", "N.g.kgsoil", "Ca.Pi.Percent", "Al.Pi.Percent", "Fe.Pi.Percent", "XANES.Total.Monoester.Percent", "XANES.Total.Diester.Percent")]
#xas.percent<-subset(xas.percent, Ca.Pi.Percent!="NA")
#colnames(xas.percent)[1:20]<-c("Horizon",  "Gradient", "Site","EEMT", "Humidity", "MAT", "MAP","pH", "Clay", "Fe", "Ca", "Al", "C", "P", "N", "Ca-Pi", "Al-Pi", "Fe-Pi", "Monoester", "Diester")
#xas.percent<-subset(xas.percent, Horizon=="A")

```

####stacked spectra and pie charts
```{r NMR fig}
#example stacked spectra
NMR_spectra_df_subset <-NMR_spectra %>%
  select("Chemical_Shift_parts_per_million", "BSLE_0013-solid", "BSLE_0007-solid","BSLE_0002-solid", "BSLE_0050-solid") %>%
  dplyr::rename('solid_13' = 'BSLE_0013-solid',
                'solid_7' = 'BSLE_0007-solid',
                'solid_2' = 'BSLE_0002-solid',
                'solid_50' = 'BSLE_0050-solid') %>%
  mutate_all(~replace(., . == 0, NA)) %>%
  mutate(solid_13 = solid_13 + 1,
         solid_7 = solid_7 + 75,
         solid_2 = solid_2 + 150,
         solid_50 = solid_50 + 225) 
         
NMR_spectra_df_subset<-melt(NMR_spectra_df_subset, id=c("Chemical_Shift_parts_per_million"))

NMR_spectra_df_subset<-subset(NMR_spectra_df_subset, value!="")

NMR_stacked_spectra_df <- ggplot(NMR_spectra_df_subset, aes(x=Chemical_Shift_parts_per_million, y = value, color = as.factor(variable))) + geom_path()+theme_classic() + ylim(0,300) + scale_x_reverse() +xlim(10,-10) +scale_color_manual(values=c('Black','Black', 'Black', 'Black')) + theme(axis.ticks.y = element_blank(),  axis.text.y = element_blank(), legend.position = "none")  + ylab("") + xlab("Chemical Shift (ppm)")

#cowplot::save_plot("../figures/NMR_stacked_spectra_df.pdf", NMR_stacked_spectra_df, ncol = 1, nrow = 1, base_aspect_ratio= 1:1.7, dpi=72)

pdf(file = "../figures/NMR_stacked_spectra_df.pdf", width = 3.5, height = 7) 
print(NMR_stacked_spectra_df)
dev.off()

NMR_spectra_sb_subset <-NMR_spectra %>%
  select("Chemical_Shift_parts_per_million", "BSLE_0014-solid", "BSLE_0011-solid","BSLE_0072-solid") %>%
  dplyr::rename('solid_14' = 'BSLE_0014-solid',
                'solid_11' = 'BSLE_0011-solid',
                'solid_72' = 'BSLE_0072-solid') %>%
  mutate_all(~replace(., . == 0, NA)) %>%
  mutate(solid_14 = solid_14 + 1,
         solid_11 = solid_11 + 75,
         solid_72 = solid_72 + 150) 
         
NMR_spectra_sb_subset<-melt(NMR_spectra_sb_subset, id=c("Chemical_Shift_parts_per_million"))

NMR_spectra_sb_subset<-subset(NMR_spectra_sb_subset, value!="")

NMR_stacked_spectra_sb <- ggplot(NMR_spectra_sb_subset, aes(x=Chemical_Shift_parts_per_million, y = value, color = as.factor(variable))) + geom_path()+theme_classic() + ylim(0,300) + scale_x_reverse() +xlim(10,-10) +scale_color_manual(values=c('Black','Black', 'Black', 'Black')) + theme(axis.ticks.y = element_blank(),  axis.text.y = element_blank(), legend.position = "none")  + ylab("") + xlab("Chemical Shift (ppm)")

#cowplot::save_plot("../figures/NMR_stacked_spectra_sb.pdf", NMR_stacked_spectra_sb, ncol = 1, nrow = 1, base_aspect_ratio= 1:1.7, dpi=72)

pdf(file = "../figures/NMR_stacked_spectra_sb.pdf", width = 3.5, height = 7) 
print(NMR_stacked_spectra_sb)
dev.off()

#pie charts
NMR <- summary_solids_conc %>%
  select("Land_Coverage_Category", "Burn_Severity","Ortho_Mean", "Mono_Mean", "Di_Mean", "Pyro_Mean") %>%
  dplyr::rename(Ortho = Ortho_Mean,
                Mono = Mono_Mean,
                Di = Di_Mean,
                Pyro = Pyro_Mean)


NMR_melt<-melt(NMR, id=c("Land_Coverage_Category", "Burn_Severity"))

NMR_melt$variable=factor(NMR_melt$variable, levels= c("Ortho", "Pyro", "Mono", "Di"))

DF.raw<-subset(NMR_melt, Land_Coverage_Category=="Douglas-fir forest" & Burn_Severity=="Unburned")
nmr.legend<-ggplot(DF.raw, aes(x = "", y = value, fill = variable)) +
    geom_col(color = "black") +
    coord_polar(theta = "y") + scale_fill_manual(values = c("#780000", "#c1121f", "#003049", "#669BBC"))+theme_void()+
    theme(legend.key.size = unit(1, 'cm'), #change legend key size
          legend.key.height = unit(1, 'cm'),  legend.title = element_text(size=25),
          legend.key.width = unit(1, 'cm'), #change legend key width
          legend.text = element_text(size=20))+labs(fill="")
pdf(file = "../figures/nmr.legend.pdf", width = 7, height = 3.5) 
print(nmr.legend)
dev.off()

DF.raw.nmr<-ggplot(DF.raw, aes(x = "", y = value, fill = variable)) +
    geom_col(color = "black") +
    coord_polar(theta = "y") + scale_fill_manual(values = c("#780000", "#c1121f", "#003049", "#669BBC"))+theme_void()+
    theme(legend.position = "none")
pdf(file = "../figures/DF.raw.nmr.pdf", width = 1, height = 1) 
print(DF.raw.nmr)
dev.off()

DF.low<-subset(NMR_melt, Land_Coverage_Category=="Douglas-fir forest" & Burn_Severity=="Low")
DF.low.nmr<-ggplot(DF.low, aes(x = "", y = value, fill = variable)) +
    geom_col(color = "black") +
    coord_polar(theta = "y") + scale_fill_manual(values = c("#780000", "#c1121f", "#003049", "#669BBC"))+theme_void()+
    theme(legend.position = "none")
pdf(file = "../figures/DF.low.nmr.pdf", width = 1, height = 1) 
print(DF.low.nmr)
dev.off()

DF.mod<-subset(NMR_melt, Land_Coverage_Category=="Douglas-fir forest" & Burn_Severity=="Moderate")
DF.mod.nmr<-ggplot(DF.mod, aes(x = "", y = value, fill = variable)) +
    geom_col(color = "black") +
    coord_polar(theta = "y") + scale_fill_manual(values = c("#780000", "#c1121f", "#003049", "#669BBC"))+theme_void()+
    theme(legend.position = "none")
pdf(file = "../figures/DF.mod.nmr.pdf", width = 1, height = 1) 
print(DF.mod.nmr)
dev.off()

DF.high<-subset(NMR_melt, Land_Coverage_Category=="Douglas-fir forest" & Burn_Severity=="High")
DF.high.nmr<-ggplot(DF.high, aes(x = "", y = value, fill = variable)) +
    geom_col(color = "black") +
    coord_polar(theta = "y") + scale_fill_manual(values = c("#780000", "#c1121f", "#003049", "#669BBC"))+theme_void()+
    theme(legend.position = "none")
pdf(file = "../figures/DF.high.nmr.pdf", width = 1, height = 1) 
print(DF.high.nmr)
dev.off()

SB.raw<-subset(NMR_melt, Land_Coverage_Category=="Sagebrush shrubland" & Burn_Severity=="Unburned")
SB.raw.nmr<-ggplot(SB.raw, aes(x = "", y = value, fill = variable)) +
    geom_col(color = "black") +
    coord_polar(theta = "y") + scale_fill_manual(values = c("#780000", "#c1121f", "#003049", "#669BBC"))+theme_void()+
    theme(legend.position = "none")
pdf(file = "../figures/SB.raw.nmr.pdf", width = 1, height = 1) 
print(SB.raw.nmr)
dev.off()

SB.low<-subset(NMR_melt, Land_Coverage_Category=="Sagebrush shrubland" & Burn_Severity=="Low")
SB.low.nmr<-ggplot(SB.low, aes(x = "", y = value, fill = variable)) +
    geom_col(color = "black") +
    coord_polar(theta = "y") + scale_fill_manual(values = c("#780000", "#c1121f", "#003049", "#669BBC"))+theme_void()+
    theme(legend.position = "none")
pdf(file = "../figures/SB.low.nmr.pdf", width = 1, height = 1) 
print(SB.low.nmr)
dev.off()

SB.mod<-subset(NMR_melt, Land_Coverage_Category=="Sagebrush shrubland" & Burn_Severity=="Moderate")
SB.mod.nmr<-ggplot(SB.mod, aes(x = "", y = value, fill = variable)) +
    geom_col(color = "black") +
    coord_polar(theta = "y") + scale_fill_manual(values = c("#780000", "#c1121f", "#003049", "#669BBC"))+theme_void()+
    theme(legend.position = "none")
pdf(file = "../figures/SB.mod.nmr.pdf", width = 1, height = 1) 
print(SB.mod.nmr)
dev.off()

```

```{r XANES fig}
#example stacked spectra
XANES_spectra_df_subset <-XANES_spectra %>%
  select("eV", "BSLE_0013-solid_P-XANES.xmu.nor", "BSLE_0007-solid_P-XANES.xmu.nor","BSLE_0002-solid_P-XANES.xmu.nor", "BSLE_0050-solid_P-XANES.xmu.nor") %>%
  dplyr::rename('solid_13' = 'BSLE_0013-solid_P-XANES.xmu.nor',
                'solid_7' = 'BSLE_0007-solid_P-XANES.xmu.nor',
                'solid_2' = 'BSLE_0002-solid_P-XANES.xmu.nor',
                'solid_50' = 'BSLE_0050-solid_P-XANES.xmu.nor') %>%
  mutate_all(~replace(., . == 0, NA)) %>%
  mutate(solid_13 = solid_13 + 1,
         solid_7 = solid_7 + 8,
         solid_2 = solid_2 + 16,
         solid_50 = solid_50 + 24) 
         
XANES_spectra_df_subset<-melt(XANES_spectra_df_subset, id=c("eV"))

XANES_spectra_df_subset<-subset(XANES_spectra_df_subset, value!="")

XANES_stacked_spectra_df <- ggplot(XANES_spectra_df_subset, aes(x=eV, y = value, color = as.factor(variable))) + geom_path()+theme_classic() + scale_color_manual(values=c('Black','Black', 'Black', 'Black')) + theme(axis.ticks.y = element_blank(),  axis.text.y = element_blank(), legend.position = "none")  + ylab("") + xlab("Energy (eV)") + xlim(2140, 2200) + ylab ("Normalized Absorption (arb. units)")

pdf(file = "../figures/XANES_stacked_spectra_df.pdf", width = 3, height = 7) 
print(XANES_stacked_spectra_df)
dev.off()

XANES_spectra_sb_subset <-XANES_spectra %>%
  select("eV", "BSLE_0014-solid_P-XANES.xmu.nor", "BSLE_0011-solid_P-XANES.xmu.nor","BSLE_0072-solid_P-XANES.xmu.nor") %>%
  dplyr::rename('solid_14' = 'BSLE_0014-solid_P-XANES.xmu.nor',
                'solid_11' = 'BSLE_0011-solid_P-XANES.xmu.nor',
                'solid_72' = 'BSLE_0072-solid_P-XANES.xmu.nor') %>%
  mutate_all(~replace(., . == 0, NA)) %>%
  mutate(blank = solid_72) %>%
  mutate(solid_14 = solid_14 + 1,
         solid_11 = solid_11 + 8,
         solid_72 = solid_72 + 16,
         blank = blank + 24) 
         
XANES_spectra_sb_subset<-melt(XANES_spectra_sb_subset, id=c("eV"))

XANES_spectra_sb_subset<-subset(XANES_spectra_sb_subset, value!="")

XANES_stacked_spectra_sb <- ggplot(XANES_spectra_sb_subset, aes(x=eV, y = value, color = as.factor(variable))) + geom_path()+theme_classic() + scale_color_manual(values=c('Black','Black', 'Black', 'White')) + theme(axis.ticks.y = element_blank(),  axis.text.y = element_blank(), legend.position = "none")  + ylab("") + xlab("Energy (eV)") + xlim(2140, 2200) + ylab ("Normalized Absorption (arb. units)")

#cowplot::save_plot("../figures/NMR_stacked_spectra_sb.pdf", NMR_stacked_spectra_sb, ncol = 1, nrow = 1, base_aspect_ratio= 1:1.7, dpi=72)

pdf(file = "../figures/XANES_stacked_spectra_sb.pdf", width = 3, height = 7) 
print(XANES_stacked_spectra_sb)
dev.off()

#pie charts with Po grouped and inorganic separate metals
XANES <- summary_solids_conc %>%
  select("Land_Coverage_Category", "Burn_Severity","XANES_Pi_K_Mean", "XANES_Pi_Mg_Mean", "XANES_Pi_Al_Mean", "XANES_Pi_Ca_Mean", "XANES_Pi_Na_Mean", "XANES_Pi_Fe_Mean", "XANES_Po_Mean") %>%
  dplyr::rename(K = XANES_Pi_K_Mean,
                Mg = XANES_Pi_Mg_Mean,
                Al = XANES_Pi_Al_Mean,
                Ca = XANES_Pi_Ca_Mean,
                Na = XANES_Pi_Na_Mean,
                Fe = XANES_Pi_Fe_Mean,
                Po = XANES_Po_Mean)

XANES_melt<-melt(XANES, id=c("Land_Coverage_Category", "Burn_Severity"))

#XANES_melt$variable=factor(XANES_melt$variable, levels= c("Ortho", "Pyro", "Mono", "Di"))

DF.raw<-subset(XANES_melt, Land_Coverage_Category=="Douglas-fir forest" & Burn_Severity=="Unburned")
xanes.legend<-ggplot(DF.raw, aes(x = "", y = value, fill = variable)) +
    geom_col(color = "black") +
    coord_polar(theta = "y") + scale_fill_manual(values = c("#424a26", "#9B9B7A", "#D9AE94", "#F1DCA7", "#FFCB69", "#D08C60", "#997B66"))+theme_void()+
    theme(legend.key.size = unit(1, 'cm'), #change legend key size
          legend.key.height = unit(1, 'cm'),  legend.title = element_text(size=25),
          legend.key.width = unit(1, 'cm'), #change legend key width
          legend.text = element_text(size=20))+labs(fill="")
pdf(file = "../figures/xanes.legend.pdf", width = 7, height = 3.5) 
print(xanes.legend)
dev.off()

DF.raw.xanes<-ggplot(DF.raw, aes(x = "", y = value, fill = variable)) +
    geom_col(color = "black") +
    coord_polar(theta = "y") + scale_fill_manual(values = c("#424a26", "#9B9B7A", "#D9AE94", "#F1DCA7", "#FFCB69", "#D08C60", "#997B66"))+theme_void()+
    theme(legend.position = "none")
pdf(file = "../figures/DF.raw.xanes.pdf", width = 1, height = 1) 
print(DF.raw.xanes)
dev.off()

DF.low<-subset(XANES_melt, Land_Coverage_Category=="Douglas-fir forest" & Burn_Severity=="Low")
DF.low.xanes<-ggplot(DF.low, aes(x = "", y = value, fill = variable)) +
    geom_col(color = "black") +
    coord_polar(theta = "y") + scale_fill_manual(values = c("#424a26", "#9B9B7A", "#D9AE94", "#F1DCA7", "#FFCB69", "#D08C60", "#997B66"))+theme_void()+
    theme(legend.position = "none")
pdf(file = "../figures/DF.low.xanes.pdf", width = 1, height = 1) 
print(DF.low.xanes)
dev.off()

DF.mod<-subset(XANES_melt, Land_Coverage_Category=="Douglas-fir forest" & Burn_Severity=="Moderate")
DF.mod.xanes<-ggplot(DF.mod, aes(x = "", y = value, fill = variable)) +
    geom_col(color = "black") +
    coord_polar(theta = "y") + scale_fill_manual(values = c("#424a26", "#9B9B7A", "#D9AE94", "#F1DCA7", "#FFCB69", "#D08C60", "#997B66"))+theme_void()+
    theme(legend.position = "none")
pdf(file = "../figures/DF.mod.xanes.pdf", width = 1, height = 1) 
print(DF.mod.xanes)
dev.off()

DF.high<-subset(XANES_melt, Land_Coverage_Category=="Douglas-fir forest" & Burn_Severity=="High")
DF.high.xanes<-ggplot(DF.high, aes(x = "", y = value, fill = variable)) +
    geom_col(color = "black") +
    coord_polar(theta = "y") + scale_fill_manual(values = c("#424a26", "#9B9B7A", "#D9AE94", "#F1DCA7", "#FFCB69", "#D08C60", "#997B66"))+theme_void()+
    theme(legend.position = "none")
pdf(file = "../figures/DF.high.xanes.pdf", width = 1, height = 1) 
print(DF.high.xanes)
dev.off()

SB.raw<-subset(XANES_melt, Land_Coverage_Category=="Sagebrush shrubland" & Burn_Severity=="Unburned")
SB.raw.xanes<-ggplot(SB.raw, aes(x = "", y = value, fill = variable)) +
    geom_col(color = "black") +
    coord_polar(theta = "y") + scale_fill_manual(values = c("#424a26", "#9B9B7A", "#D9AE94", "#F1DCA7", "#FFCB69", "#D08C60", "#997B66"))+theme_void()+
    theme(legend.position = "none")
pdf(file = "../figures/SB.raw.xanes.pdf", width = 1, height = 1) 
print(SB.raw.xanes)
dev.off()

SB.low<-subset(XANES_melt, Land_Coverage_Category=="Sagebrush shrubland" & Burn_Severity=="Low")
SB.low.xanes<-ggplot(SB.low, aes(x = "", y = value, fill = variable)) +
    geom_col(color = "black") +
    coord_polar(theta = "y") + scale_fill_manual(values = c("#424a26", "#9B9B7A", "#D9AE94", "#F1DCA7", "#FFCB69", "#D08C60", "#997B66"))+theme_void()+
    theme(legend.position = "none")
pdf(file = "../figures/SB.low.xanes.pdf", width = 1, height = 1) 
print(SB.low.xanes)
dev.off()

SB.mod<-subset(XANES_melt, Land_Coverage_Category=="Sagebrush shrubland" & Burn_Severity=="Moderate")
SB.mod.xanes<-ggplot(SB.mod, aes(x = "", y = value, fill = variable)) +
    geom_col(color = "black") +
    coord_polar(theta = "y") + scale_fill_manual(values = c("#424a26", "#9B9B7A", "#D9AE94", "#F1DCA7", "#FFCB69", "#D08C60", "#997B66"))+theme_void()+
    theme(legend.position = "none")
pdf(file = "../figures/SB.mod.xanes.pdf", width = 1, height = 1) 
print(SB.mod.xanes)
dev.off()
```

#SEM
```{r path analysis}
#reference: https://stats.oarc.ucla.edu/r/seminars/rsem/ #followed Model 4A
#reference: https://kevintshoemaker.github.io/NRES-746/SEM.RMarkdown.html
#reference: https://bookdown.org/jdholster1/idsr/structural-equation-modeling.html

#make dataframe with solid samples (leachate avg) to prevent using same number so many times
leachate_mean <- data %>%
  dplyr::group_by(Parent_ID) %>%
  dplyr::summarize(
    Leachate_P_mg_kgchar_unfilt_Mean = mean(Leachate_P_mg_kgchar_unfilt, na.rm = TRUE),
    Leachate_P_mg_kgchar_part_Mean = mean(Leachate_P_mg_kgchar_part, na.rm = TRUE),
    Leachate_P_mg_kgchar_filt0.7_Mean = mean(Leachate_P_mg_kgchar_filt0.7, na.rm = TRUE),
    MBD_P_mg_kgchar_Mean = mean(MBD_P_mg_kgchar, na.rm = TRUE),
    pH_Mean = mean(pH)
  )

solid <- data_solids %>%
  select(1,3, 5, 10, 11, 31:34, 88, 96:101, 111:120)

data_rda<- solid %>%
  full_join(leachate_mean)

#normalize data
data_rda_sub<-as.data.frame(scale(data_rda[4:31]))

data_rda_combine<-cbind(data_rda[,c(1:3)], data_rda_sub)


data_rda_combine$Burn_Severity=as.numeric(factor(data_rda_combine$Burn_Severity, levels= c("Unburned", "Low", "Moderate", "High")))

#Path analysis for P mobilization in aqueous phase
model <- '
  # Measurement Model; set up the latent variable(s)
    Pi =~ XANES_Pi_Ca + XANES_Pi_Mg
  
  # Structural Model
    Solid_P_g_kg ~ Burn_Severity
    Pi ~ Burn_Severity
    Leachate_P_mg_kgchar_filt0.7_Mean ~ Pi + Solid_P_g_kg + Burn_Severity
    
  # Residual Variances
    XANES_Pi_Ca ~~ XANES_Pi_Ca
    XANES_Pi_Mg ~~ XANES_Pi_Mg
    Leachate_P_mg_kgchar_filt0.7_Mean ~~ Leachate_P_mg_kgchar_filt0.7_Mean
'

# Fit the SEM model
fit <- sem(model, data = data_rda_combine)
#fit<-cfa(model, data = data_rda_combine)

# Summarize the results
summary(fit, fit.measures=TRUE, standardized=TRUE)
fitMeasures(fit, c("chisq", "rmsea", "srmr", "gfi", "ecvi"))

#visualize it
semPlot::semPaths(fit, "std", edge.label.cex = 1.0, curvePivot = FALSE, rotation = 3)
semPlot::semPaths(fit, what = "path", whatLabels = "std", style = "lisrel", edge.label.cex = .9, rotation = 2, curve = 2, layoutSplit = FALSE, normalize = FALSE, height = 9, width = 6.5, residScale = 10)
semPlot::semPaths(fit, style="lisrel", 
        whatLabels = "std", edge.label.cex = .6, node.label.cex = .6, 
        label.prop=0.9, edge.label.color = "black", rotation = 4, 
        equalizeManifests = FALSE, optimizeLatRes = TRUE, node.width = 1.5, 
        edge.width = 0.5, shapeMan = "rectangle", shapeLat = "ellipse", 
        shapeInt = "triangle", sizeMan = 4, sizeInt = 2, sizeLat = 4, 
        curve=2, unCol = "#070b8c")

```








#haven't updated below here yet (NMR and XANES code) fix


#spectra stacked
#spectra <- read.csv("~/Library/CloudStorage/OneDrive-SharedLibraries-PNNL/RC-3, River Corridor SFA - Presentations/ESA_2023/Morgan/spectra.csv")


#filt<-spectra[ -c(6:9)]
#filt$P_BSLE_0007_filt07_sample<-filt$P_BSLE_0007_filt07_sample+7
#filt$P_BSLE_0002_filt07_sample<-filt$P_BSLE_0002_filt07_sample+14
#filt$P_BSLE_0050_filt07_sample<-filt$P_BSLE_0050_filt07_sample+21
#filt<-melt(filt, id=c("energy"))

#ggplot(filt, aes(x=energy, y=value))+geom_line(aes(color = variable), show.legend = FALSE)+theme_classic()+ylab("Noramlized Absorption (arb. units)")+ xlab("Energy (eV)")+theme(text = element_text(size = 15))+xlim(2140,2200)+scale_color_manual(values=c('Black','Black', 'Black', 'Black'))




#plot spectra of samples
#BSLE_solid_sample_spectra_normalizedforfinalLCF_12.1.22 <- read.csv("~/PNNL/RC-3, River Corridor SFA - Burn Severity Experiments/Burn Severity Experiment/Data/P_all data streams/P XAS/Processed_final/BSLE_Solids_Final_Fits/BSLE_solid_sample_spectra_normalizedforfinalLCF_12.1.22.csv")


#DFL<-BSLE_solid_sample_spectra_normalizedforfinalLCF_12.1.22[ c(25, 20, 19, 13, 1)]
#DFL<-melt(DFL, id=c("energy"))

#ggplot(DFL, aes(x=energy, y=value))+geom_line()+theme_classic()+ylab("Noramlized Absorption (arb. units)")+ xlab("Energy (eV)")+facet_grid(variable~.)+theme(text = element_text(size = 15))+xlim(2140,2200)



#try to stack them differently
#DFL<-BSLE_solid_sample_spectra_normalizedforfinalLCF_12.1.22[ c(25, 20, 19, 13, 1)]
#DFL$P_BSLE_0073_solidchar_036_fl_4s_avg<-DFL$P_BSLE_0073_solidchar_036_fl_4s_avg+9
#DFL$P_BSLE_0052_solidchar_035_fl_6sc_avg<-DFL$P_BSLE_0052_solidchar_035_fl_6sc_avg+6
#DFL$P_BSLE_0051_solidchar_034_fl_6s_avg<-DFL$P_BSLE_0051_solidchar_034_fl_6s_avg+3
#DFL<-melt(DFL, id=c("energy"))

#DFL.sample.xas.spectra.gradient<-ggplot(DFL, aes(x=energy, y=value))+geom_line(aes(color = variable), show.legend = FALSE)+theme_classic()+ylab("Noramlized Absorption (arb. units)")+ xlab("Energy (eV)")+theme(text = element_text(size = 15))+xlim(2140,2200)+scale_color_manual(values=c('Black','Black', 'Black', 'Black'))






